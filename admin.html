<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chaudhary Kirana Store - Admin Panel</title>
    <!-- Google Fonts: Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-red: #e74a3b;
            --text-color: #333;
            --muted-color: #777;
            --surface-color: #fff;
            --surface-dark-color: #f8f9fa;
            --border-color: #eee;
            --shadow-color: rgba(0, 0, 0, 0.08);
            --card-border-radius: 18px;
        }
        
        /* Dark Mode Colors */
        [data-theme="dark"] {
            --primary-red: #ff6b6b;
            --text-color: #ffffff;
            --muted-color: #b0b0b0;
            --surface-color: #2d2d2d;
            --surface-dark-color: #1a1a1a;
            --border-color: #444;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --card-bg: #3a3a3a;
            --input-bg: #2d2d2d;
            --button-bg: #4a4a4a;
            --button-hover-bg: #5a5a5a;
        }
        
        /* Smooth theme transitions */
        * {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--surface-dark-color);
            color: var(--text-color);
            line-height: 1.6;
            padding-bottom: 80px; /* Space for bottom navigation */
        }
        
        /* Dark mode body */
        [data-theme="dark"] body {
            background-color: var(--surface-dark-color);
        }

        /* Fixed Top Header */
        .admin-header {
            background-color: var(--surface-color);
            padding: 15px 20px;
            box-shadow: 0 2px 10px var(--shadow-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            border-bottom: 1px solid var(--border-color);
        }
        
        /* Dark mode header */
        [data-theme="dark"] .admin-header {
            background-color: var(--surface-color);
            border-bottom: 1px solid var(--border-color);
        }

        /* Dark mode main content */
        [data-theme="dark"] .admin-content {
            background-color: var(--surface-dark-color);
        }

        /* Dark mode cards and sections */
        [data-theme="dark"] .card,
        [data-theme="dark"] .section-card,
        [data-theme="dark"] .product-card,
        [data-theme="dark"] .order-card,
        [data-theme="dark"] .message-card,
        [data-theme="dark"] .slider-image-card {
            background-color: var(--card-bg) !important;
            border-color: var(--border-color) !important;
            color: var(--text-color) !important;
        }

        /* Dark mode section headers */
        [data-theme="dark"] .section-header,
        [data-theme="dark"] .section-title {
            color: var(--text-color) !important;
        }

        /* Dark mode buttons */
        [data-theme="dark"] .btn-primary,
        [data-theme="dark"] .add-product-btn,
        [data-theme="dark"] .add-slider-image-btn {
            background-color: var(--button-bg);
            color: var(--text-color);
        }

        [data-theme="dark"] .btn-secondary,
        [data-theme="dark"] .edit-btn,
        [data-theme="dark"] .edit-product-btn,
        [data-theme="dark"] .edit-slider-image-btn {
            background-color: var(--button-bg) !important;
            color: var(--text-color) !important;
            border-color: var(--border-color) !important;
        }

        /* Dark mode for white elements in Products, Messages, and Slider tabs */
        [data-theme="dark"] .product-card,
        [data-theme="dark"] .message-card,
        [data-theme="dark"] .slider-image-card {
            background-color: var(--card-bg) !important;
            border-color: var(--border-color) !important;
            color: var(--text-color) !important;
        }

        /* Dark mode for main section cards (Products, Messages, Slider) */
        [data-theme="dark"] #products .card,
        [data-theme="dark"] #messages .card,
        [data-theme="dark"] #slider .card {
            background-color: var(--card-bg) !important;
            border-color: var(--border-color) !important;
            color: var(--text-color) !important;
        }

        /* Force dark theme for all cards in dark mode */
        [data-theme="dark"] .card {
            background-color: var(--card-bg) !important;
            border-color: var(--border-color) !important;
            color: var(--text-color) !important;
        }

        /* Force dark theme for specific section cards */
        [data-theme="dark"] .admin-section .card {
            background-color: var(--card-bg) !important;
            border-color: var(--border-color) !important;
            color: var(--text-color) !important;
        }

        /* Dark mode for text elements in cards */
        [data-theme="dark"] .product-card .product-name,
        [data-theme="dark"] .product-card .product-category,
        [data-theme="dark"] .product-card .product-price,
        [data-theme="dark"] .message-card .message-sender,
        [data-theme="dark"] .message-card .message-email,
        [data-theme="dark"] .message-card .message-content,
        [data-theme="dark"] .slider-image-card .slider-url-label {
            color: var(--text-color) !important;
        }

        /* Dark mode for labels in cards */
        [data-theme="dark"] .product-card .product-label,
        [data-theme="dark"] .message-card .message-label,
        [data-theme="dark"] .slider-image-card .slider-url-label {
            color: var(--primary-red) !important;
        }

        /* Dark mode for input fields in cards */
        [data-theme="dark"] .slider-image-card input[type="text"],
        [data-theme="dark"] .slider-image-card input[type="url"] {
            background-color: var(--input-bg) !important;
            color: var(--text-color) !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .btn-secondary:hover,
        [data-theme="dark"] .edit-btn:hover,
        [data-theme="dark"] .edit-product-btn:hover,
        [data-theme="dark"] .edit-slider-image-btn:hover {
            background-color: var(--button-hover-bg) !important;
        }

        [data-theme="dark"] .btn-danger,
        [data-theme="dark"] .delete-btn,
        [data-theme="dark"] .delete-product-btn,
        [data-theme="dark"] .delete-slider-image-btn {
            background-color: var(--primary-red) !important;
            color: white !important;
        }

        /* Dark mode form elements */
        [data-theme="dark"] input,
        [data-theme="dark"] textarea,
        [data-theme="dark"] select {
            background-color: var(--input-bg) !important;
            color: var(--text-color) !important;
            border-color: var(--border-color) !important;
        }

        /* Dark mode tables */
        [data-theme="dark"] table {
            background-color: var(--card-bg) !important;
            color: var(--text-color) !important;
        }

        [data-theme="dark"] th,
        [data-theme="dark"] td {
            border-color: var(--border-color) !important;
            color: var(--text-color) !important;
        }

        /* Dark mode modals */
        [data-theme="dark"] .modal-content,
        [data-theme="dark"] .modal-header,
        [data-theme="dark"] .modal-body {
            background-color: var(--card-bg) !important;
            color: var(--text-color) !important;
            border-color: var(--border-color) !important;
        }

        /* Dark mode status badges */
        [data-theme="dark"] .status-badge,
        [data-theme="dark"] .order-status-badge {
            color: white !important;
        }

        /* Dark mode icons */
        [data-theme="dark"] .icon-btn {
            color: var(--text-color) !important;
        }

        /* Dark mode search inputs */
        [data-theme="dark"] .search-input,
        [data-theme="dark"] #order-search-input {
            background-color: var(--input-bg) !important;
            color: var(--text-color) !important;
            border-color: var(--border-color) !important;
        }

        /* Dark mode product cards */
        [data-theme="dark"] .product-card {
            background-color: var(--card-bg) !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .product-card .product-name,
        [data-theme="dark"] .product-card .product-category,
        [data-theme="dark"] .product-card .product-price {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .product-card .product-label {
            color: var(--primary-red) !important;
        }







        /* Dark mode order cards */
        [data-theme="dark"] .order-card {
            background-color: var(--card-bg) !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .order-card .order-customer-name,
        [data-theme="dark"] .order-card .order-mobile,
        [data-theme="dark"] .order-card .order-address,
        [data-theme="dark"] .order-card .order-details {
            color: var(--text-color) !important;
        }

        /* Dark mode message cards */
        [data-theme="dark"] .message-card {
            background-color: var(--card-bg) !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .message-card .message-sender,
        [data-theme="dark"] .message-card .message-email,
        [data-theme="dark"] .message-card .message-content {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .message-card .message-label {
            color: var(--primary-red) !important;
        }

        /* Dark mode slider image cards */
        [data-theme="dark"] .slider-image-card {
            background-color: var(--card-bg) !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .slider-image-card .slider-url-label {
            color: var(--primary-red) !important;
        }

        [data-theme="dark"] .slider-image-card .slider-url-input {
            background-color: var(--input-bg) !important;
            color: var(--text-color) !important;
            border-color: var(--border-color) !important;
        }

        /* Dark mode section titles and descriptions */
        [data-theme="dark"] .section-title,
        [data-theme="dark"] .section-description {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .section-description {
            color: var(--muted-color) !important;
        }

                .admin-header .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--primary-red);
                font-size: 1.2rem;
                font-weight: 700;
        }
        
        /* Theme Toggle Styles */
        .theme-toggle-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .theme-toggle-icon {
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 8px;
            border-radius: 8px;
        }
        
        .theme-toggle-icon:hover {
            background-color: rgba(231, 74, 59, 0.1);
            transform: scale(1.1);
        }
        
        .theme-toggle-icon:active {
            transform: scale(0.95);
        }
        
        /* Dark mode logo text */
        [data-theme="dark"] .admin-header .logo span {
            color: var(--text-color);
        }

        .admin-header .logo span {
            color: var(--primary-red) !important;
        }

        .admin-header .logo i {
            font-size: 1.5rem;
            color: white;
        }

        .admin-header .admin-profile {
                display: flex;
                align-items: center;
            gap: 8px;
            color: var(--primary-red);
                font-size: 0.9rem;
            font-weight: 600;
        }
        
        /* Admin Profile Container */
        .admin-profile-container {
            position: relative;
            display: inline-block;
        }
        
        .admin-profile-info {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }
        
        .admin-profile-info:hover {
            background-color: rgba(231, 74, 59, 0.1);
        }
        
        /* Admin Profile Dropdown */
        .admin-profile-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2), 
                        0 4px 16px rgba(0, 0, 0, 0.1),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3);
            min-width: 280px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
            margin-top: 8px;
        }
        
        .admin-profile-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .admin-profile-dropdown-content {
            padding: 24px;
            background: transparent;
        }
        
        .admin-profile-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 18px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .admin-profile-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .admin-profile-action-btn {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 12px 16px;
            border-radius: 12px;
            color: #2c3e50;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            width: 100%;
            text-align: left;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            justify-content: flex-start;
        }
        
        .admin-profile-action-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(231, 74, 59, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }
        
        .admin-profile-action-btn i {
            color: var(--primary-red);
        }
        
        /* Dark mode support for admin dropdown */
        [data-theme="dark"] .admin-profile-dropdown {
            background: rgba(30, 30, 30, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 
                        0 4px 16px rgba(0, 0, 0, 0.2),
                        inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        
        /* Dark mode admin profile info */
        [data-theme="dark"] .admin-profile-info:hover {
            background-color: rgba(255, 107, 107, 0.1);
        }
        
        [data-theme="dark"] .admin-profile-header {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        [data-theme="dark"] .admin-profile-action-btn {
            background: rgba(255, 255, 255, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        [data-theme="dark"] .admin-profile-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: var(--primary-red);
        }
        
        [data-theme="dark"] .admin-profile-action-btn i {
            color: #ffffff;
        }
        
        /* Mobile responsiveness for admin profile */
        @media (max-width: 768px) {
            .admin-profile-dropdown {
                min-width: 250px;
                right: -10px;
            }
            
            .admin-profile-dropdown-content {
                padding: 20px;
            }
            
            .admin-profile-action-btn {
                padding: 10px 14px;
                font-size: 0.85rem;
            }
            
            .admin-name {
                font-size: 0.9rem;
            }
        }
        
        /* Dark mode modal styles */
        [data-theme="dark"] #admin-auth-modal .card,
        [data-theme="dark"] #product-manage-modal .card,
        [data-theme="dark"] #add-slider-image-modal .card,
        [data-theme="dark"] #order-details-modal .card,
        [data-theme="dark"] #status-update-modal .card {
            background-color: var(--card-bg) !important;
            border-color: var(--border-color) !important;
            color: var(--text-color) !important;
        }
        
        /* Dark mode search section */
        [data-theme="dark"] #order-search-input {
            background-color: var(--surface-dark-color);
            border-color: var(--border-color);
            color: var(--text-color);
        }
        
        [data-theme="dark"] #order-search-input:focus {
            background-color: var(--surface-color);
            border-color: var(--primary-red);
        }
        
        @media (max-width: 480px) {
            .admin-profile-dropdown {
                min-width: 220px;
                right: -15px;
            }
            
            .admin-profile-dropdown-content {
                padding: 16px;
            }
            
            .admin-profile-action-btn {
                padding: 8px 12px;
                font-size: 0.8rem;
            }
        }




        
        /* Google Sign-In Button Hover Effects */
        #admin-google-signin-btn:hover {
            background-color: #3367d6 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.4);
        }
        
        /* Dark mode input fields */
        [data-theme="dark"] input,
        [data-theme="dark"] textarea,
        [data-theme="dark"] select {
            background-color: var(--surface-dark-color);
            border-color: var(--border-color);
            color: var(--text-color);
        }
        
        [data-theme="dark"] input:focus,
        [data-theme="dark"] textarea:focus,
        [data-theme="dark"] select:focus {
            background-color: var(--surface-color);
            border-color: var(--primary-red);
        }
        
        /* Dark mode table styles */
        [data-theme="dark"] table {
            background-color: var(--surface-color);
            color: var(--text-color);
        }
        
        [data-theme="dark"] th,
        [data-theme="dark"] td {
            border-color: var(--border-color);
        }
        
        [data-theme="dark"] th {
            background-color: var(--surface-dark-color);
        }



        /* Main Content */
        .admin-content {
            padding: 100px 15px 20px 15px;
            max-width: 1200px;
                margin: 0 auto;
        }
        
        /* Dark mode content */
        [data-theme="dark"] .admin-content {
            background-color: var(--surface-dark-color);
        }

        /* Section Styling */
        .admin-section {
            display: none;
            margin-bottom: 30px;
        }

        /* All sections - consistent spacing */
        .admin-section {
            padding-top: 90px;
        }

        .admin-section h2 {
            margin-bottom: 60px;
        }

        .admin-section .card {
            margin-top: 35px;
        }

        /* Products section specific */
        #products .card {
            margin-top: 25px;
        }



        

        /* Slider section specific */
        #slider .card {
            margin-top: 25px;
        }

        /* Messages section specific */
        #messages .card {
            margin-top: 25px;
        }

        .admin-section.active {
            display: block;
        }

        .admin-section h2 {
            font-size: 1.8rem;
            margin-top: 30px;
            margin-bottom: 20px;
                text-align: center;
            color: var(--primary-red);
            font-weight: 700;
        }

        .admin-section h3 {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: var(--text-color);
            font-weight: 600;
        }

        /* Card Styling */
        .card {
            background-color: var(--surface-color);
            border-radius: var(--card-border-radius);
            box-shadow: 0 4px 15px var(--shadow-color);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        /* Stats Cards */
        #stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--surface-color);
            padding: 25px 20px;
            border-radius: var(--card-border-radius);
            text-align: center;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 15px var(--shadow-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px var(--shadow-color);
        }
        
        /* Dark mode stat cards */
        [data-theme="dark"] .stat-card {
            background: var(--surface-color);
            border-color: var(--border-color);
            box-shadow: 0 4px 12px var(--shadow-color);
        }
        
        [data-theme="dark"] .stat-card:hover {
            box-shadow: 0 8px 25px var(--shadow-color);
        }

        .stat-card .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-red);
            margin-bottom: 10px;
        }

        .stat-card .stat-label {
            font-size: 1rem;
            color: var(--muted-color);
            font-weight: 500;
        }

        /* Button Styling */
            button, .btn {
                background: var(--primary-red);
                color: white;
                border: none;
                border-radius: 12px;
            padding: 12px 20px;
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
            }
            
        /* Dark mode buttons */
        [data-theme="dark"] button, [data-theme="dark"] .btn {
            background: var(--primary-red);
            color: white;
        }

            button:hover, .btn:hover {
                background: #c0392b;
                transform: translateY(-2px);
                box-shadow: 0 4px 15px rgba(231, 74, 59, 0.4);
            }

            #add-product-btn, #add-slider-image-btn {
                background: var(--primary-red);
                color: white;
            padding: 14px 24px;
            font-size: 1rem;
                border-radius: 12px;
            margin: 10px 0;
            display: inline-block;
        }

        /* Time Period Buttons */
            .time-btn {
            background: var(--surface-dark-color);
            color: var(--muted-color);
            border: 2px solid var(--border-color);
            border-radius: 20px;
            padding: 8px 16px;
                margin: 5px;
                font-size: 0.9rem;
                font-weight: 500;
            transition: all 0.3s ease;
                display: inline-block;
            }
            
        /* Dark mode time buttons */
        [data-theme="dark"] .time-btn {
            background: var(--surface-dark-color);
            color: var(--muted-color);
            border-color: var(--border-color);
        }

            .time-btn.active {
                background: var(--primary-red);
                color: white;
                border-color: var(--primary-red);
        }

        /* Table Styling */
            .admin-section table {
                width: 100%;
            border-collapse: collapse;
            background: var(--surface-color);
            border-radius: var(--card-border-radius);
            overflow: hidden;
            box-shadow: 0 4px 15px var(--shadow-color);
        }

        .admin-section thead {
            background: var(--surface-dark-color);
        }

        .admin-section th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: var(--text-color);
            border-bottom: 1px solid var(--border-color);
        }

        .admin-section td {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }

        .admin-section tbody tr:last-child td {
                border-bottom: none;
            }

        /* Action Buttons */
            .icon-btn {
            background: var(--surface-dark-color);
            border: 1px solid var(--border-color);
                border-radius: 8px;
                padding: 8px 12px;
                margin: 0 3px;
            color: var(--muted-color);
            transition: all 0.3s ease;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                min-width: 40px;
                min-height: 40px;
            }

            .icon-btn:hover {
            background: var(--border-color);
                transform: scale(1.05);
            }

            .edit-product-btn, .edit-slider-image-btn {
                background: #e3f2fd;
                color: #1976d2;
                border-color: #bbdefb;
            }

            .delete-product-btn, .delete-slider-image-btn {
                background: #ffebee;
                color: #d32f2f;
                border-color: #ffcdd2;
            }

            .view-order-btn {
                background: #e8f5e8;
                color: #388e3c;
                border-color: #c8e6c9;
            }

        /* Form Styling */
            form {
                display: flex;
                flex-direction: column;
                gap: 20px;
                margin: 20px 0;
            }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-weight: 600;
            color: var(--text-color);
        }

        input, textarea, select {
            padding: 12px 16px;
                font-size: 1rem;
            border: 2px solid var(--border-color);
                border-radius: 12px;
            background: var(--surface-dark-color);
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
        }

        input:focus, textarea:focus, select:focus {
                border-color: var(--primary-red);
                background: white;
                outline: none;
                box-shadow: 0 0 0 3px rgba(231, 74, 59, 0.1);
            }

        /* Modal Styling */
            .modal-content {
                background: white;
                border-radius: 20px;
            padding: 30px;
                margin: 20px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            border: 1px solid var(--border-color);
            max-height: 90vh;
            overflow-y: auto;
            }

        /* Image Styling */
            .admin-product-image, .admin-slider-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
                border-radius: 8px;
            border: 2px solid var(--border-color);
        }

        /* Status Badges */
            .order-status-select {
            padding: 8px 12px;
            border-radius: 20px;
            border: 2px solid var(--border-color);
            background: var(--surface-dark-color);
                font-size: 0.9rem;
                font-weight: 600;
            color: var(--text-color);
                transition: all 0.3s ease;
            }

            .order-status-select:focus {
                border-color: var(--primary-red);
                box-shadow: 0 0 0 3px rgba(231, 74, 59, 0.1);
            }

        /* Bottom Navigation */
        .admin-bottom-nav {
            background-color: var(--surface-color);
            box-shadow: 0 -2px 10px var(--shadow-color);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 10px;
            border-top: 1px solid var(--border-color);
        }
        
        /* Dark mode bottom navigation */
        [data-theme="dark"] .admin-bottom-nav {
            background-color: var(--surface-color);
            border-top-color: var(--border-color);
            box-shadow: 0 -2px 10px var(--shadow-color);
        }
        
        /* Enhanced dark mode navigation styling */
        [data-theme="dark"] .admin-bottom-nav {
            background-color: #2d2d2d;
            border-top-color: #444;
        }

        .admin-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--muted-color);
                transition: all 0.3s ease;
            padding: 6px 8px;
            border-radius: 8px;
            min-width: 50px;
            flex: 1;
        }
        
        /* Dark mode navigation items - better contrast */
        [data-theme="dark"] .admin-nav-item {
            color: var(--muted-color);
        }

        .admin-nav-item:hover {
            color: var(--primary-red);
            background-color: var(--surface-dark-color);
        }
        
        /* Enhanced hover effects for dark mode */
        [data-theme="dark"] .admin-nav-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .admin-nav-item.active {
            color: var(--primary-red);
            background-color: rgba(231, 74, 59, 0.1);
        }
        
        /* Dark mode navigation items */
        [data-theme="dark"] .admin-nav-item:hover {
            background-color: var(--surface-color);
        }
        
        [data-theme="dark"] .admin-nav-item.active {
            background-color: rgba(255, 107, 107, 0.2);
            color: var(--primary-red);
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
        }

        .admin-nav-item i {
            font-size: 1.1rem;
            margin-bottom: 3px;
        }

        .admin-nav-item span {
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        /* Dark mode navigation icons and text */
        [data-theme="dark"] .admin-nav-item i {
            color: var(--muted-color);
        }
        
        [data-theme="dark"] .admin-nav-item.active i {
            color: var(--primary-red);
        }
        
        [data-theme="dark"] .admin-nav-item span {
            color: var(--muted-color);
        }
        
        [data-theme="dark"] .admin-nav-item.active span {
            color: var(--primary-red);
        }

        /* Loading States */
        .loading {
            text-align: center;
            padding: 40px;
        }

        .loading i {
            font-size: 2rem;
            color: var(--primary-red);
            animation: spin 1s linear infinite;
        }
        
        /* Dark mode loading */
        [data-theme="dark"] .loading {
            color: var(--text-color);
        }
        
        /* Skeleton Loading Styles */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 8px;
        }
        
        /* Dark mode skeleton */
        [data-theme="dark"] .skeleton {
            background: linear-gradient(90deg, #2a2a2a 25%, #3a3a3a 50%, #2a2a2a 75%);
            background-size: 200% 100%;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Mobile Responsive Design */
        @media (max-width: 768px) {
            .admin-content {
                padding: 90px 10px 20px 10px;
            }

            .admin-header {
                padding: 12px 15px;
            }

            .admin-header .logo {
                font-size: 1rem;
            }

            .admin-header .admin-profile {
                font-size: 0.8rem;
            }



            .admin-section {
                padding-top: 55px;
            }

            .admin-section h2 {
                font-size: 1.5rem;
                margin-bottom: 40px;
            }

            .admin-section h3 {
                font-size: 1.1rem;
                margin-bottom: 15px;
            }

            .admin-section .card {
                margin-top: 30px;
            }

            .card {
                padding: 15px;
                margin-bottom: 15px;
            }



            #stats-cards {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .stat-card {
                padding: 20px 15px;
            }

            .stat-card .stat-number {
                font-size: 2rem;
            }

            /* Mobile Table Layout */
            .admin-section table {
                display: block;
                overflow-x: auto;
            }

            .admin-section thead {
                display: none;
            }

            .admin-section tbody,
            .admin-section tr,
            .admin-section td {
                display: block;
            }

            .admin-section tr {
                margin-bottom: 15px;
                border: 1px solid var(--border-color);
                border-radius: 12px;
                padding: 15px;
                background: white;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }

            .admin-section td {
                text-align: center;
                padding: 12px 0;
                border: none;
                border-bottom: 1px solid var(--border-color);
                position: relative;
                min-height: 50px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }

            .admin-section td:last-child {
                border-bottom: none;
            }

            .admin-section td::before {
                content: attr(data-label);
                font-weight: 700;
                color: var(--primary-red);
                font-size: 0.8rem;
                margin-bottom: 8px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            /* Special handling for image and action columns */
            .admin-section td:first-child::before,
            .admin-section td:last-child::before {
                display: none;
            }

            .admin-section td:first-child {
                text-align: center;
                justify-content: center;
            }

            .admin-section td:last-child {
                text-align: center;
                justify-content: center;
            }

            /* Mobile Button Layout */
            button, .btn {
                width: 100%;
                max-width: 300px;
                margin: 8px auto;
                display: block;
            }





            /* Mobile Form Layout */
            form input, form textarea, form select {
                width: 100%;
                margin-bottom: 10px;
            }

            /* Mobile Modal Layout */
            .modal-content {
                width: 95%;
                margin: 20px auto;
                padding: 20px;
            }

            /* Mobile Navigation */
            .admin-bottom-nav {
                padding: 10px 5px;
            }

            .admin-nav-item {
                min-width: 45px;
                padding: 5px 4px;
            }

            .admin-nav-item i {
                font-size: 1rem;
            }

            .admin-nav-item span {
                font-size: 0.65rem;
            }

            /* Better mobile touch targets */
            .icon-btn {
                min-width: 50px;
                min-height: 50px;
                margin: 5px;
                border-radius: 12px;
                font-size: 1rem;
                transition: all 0.3s ease;
            }

            .icon-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            }

            .icon-btn:active {
                transform: scale(0.95);
                transition: transform 0.1s ease;
            }

            /* Mobile grocery button styling */
            #add-grocery-btn {
                width: 100%;
                max-width: 350px;
                margin: 15px auto;
                display: block;
                padding: 18px 20px;
                font-size: 1rem;
                border-radius: 16px;
                box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
            }

            /* Mobile status select styling */
            .order-status-select {
                min-height: 44px;
                font-size: 1rem;
                padding: 12px 16px;
                border-radius: 12px;
                border: 2px solid var(--border-color);
                background: var(--surface-dark-color);
                transition: all 0.3s ease;
                width: 100%;
                max-width: 200px;
                margin: 0 auto;
                display: block;
            }

            .order-status-select:focus {
                border-color: var(--primary-red);
                box-shadow: 0 0 0 3px rgba(231, 74, 59, 0.1);
                background: white;
            }

            /* Enhanced mobile experience */
            .admin-section {
                animation: slideInUp 0.5s ease-out;
            }

            @keyframes slideInUp {
                from {
                    opacity: 0;
                    transform: translateY(30px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            /* Better mobile shadows and borders */
            .card, .stat-card {
                border: 1px solid rgba(0,0,0,0.1);
                transition: all 0.3s ease;
            }

            .card:hover, .stat-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            }

            /* Mobile-optimized header */
                .admin-header {
                backdrop-filter: blur(10px);
                background: rgba(255, 255, 255, 0.95);
                border-bottom: 1px solid rgba(0, 0, 0, 0.1);
                }

            /* Mobile-optimized bottom navigation */
                .admin-bottom-nav {
                backdrop-filter: blur(10px);
                background: rgba(255, 255, 255, 0.95);
                border-top: 1px solid rgba(0,0,0,0.1);
            }

            #add-grocery-btn:hover {
                transform: translateY(-3px);
                box-shadow: 0 8px 25px rgba(40, 167, 69, 0.5);
            }

            #add-grocery-btn:active {
                transform: translateY(-1px);
                box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
            }
        }

        /* Extra Small Devices */
        @media (max-width: 480px) {
            .admin-content {
                padding: 85px 8px 20px 8px;
            }

            .admin-header {
                padding: 10px 12px;
            }

            .admin-header .logo {
                font-size: 0.9rem;
            }

            .admin-section h2 {
                font-size: 1.3rem;
            }

            .admin-section h3 {
                font-size: 1rem;
            }

            .card {
                padding: 12px;
            }

            .stat-card {
                padding: 15px 12px;
            }

            .stat-card .stat-number {
                font-size: 1.8rem;
            }

            button, .btn {
                padding: 10px 16px;
                font-size: 0.9rem;
            }

            .admin-section td {
                padding: 15px 0;
                min-height: 60px;
            }

            .admin-section td::before {
                font-size: 0.75rem;
            }
        }

        /* Hide sections by default */
        .admin-section {
            display: none;
        }

        .admin-section.active {
            display: block;
        }

        /* Blur overlay for login */
        .blur-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            z-index: 2999;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            pointer-events: auto;
        }

        .blur-overlay ~ .admin-bottom-nav {
            z-index: 10000 !important;
        }
        /* Mobile-specific table improvements */
        @media (max-width: 768px) {
            .admin-content {
                padding: 15px 10px;
            }
            
            /* Removed specific order-table-container rules to match Products tab responsiveness */
            
            .order-status-select {
                font-size: 12px !important;
                padding: 4px 6px !important;
                min-width: 80px !important;
            }
            
            .view-order-btn,
            .delete-order-btn {
                padding: 4px !important;
                font-size: 14px !important;
            }

                        /* Orders section now matches Products tab responsiveness */
        }

        /* Order cards now use standard card styling for consistent responsiveness */
        
        @media (max-width: 480px) {
            .admin-section {
                padding-top: 40px;
            }

            .admin-section h2 {
                font-size: 1.3rem;
                margin-bottom: 30px;
            }

            /* Removed specific order-table-container rules for consistent responsiveness */
            
            .order-status-select {
                font-size: 11px !important;
                padding: 3px 4px !important;
            }

            .time-btn {
                padding: 5px 10px;
                font-size: 0.75rem;
            }
        }

        /* Modal Close Button Styles */
        .modal-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary-red);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s ease;
            z-index: 1001;
        }

        .modal-close-btn:hover {
            background: #e74a3b;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(231, 74, 59, 0.4);
        }

        .modal-close-btn:active {
            transform: scale(0.95);
        }

        /* Status Update Button Hover Effects */
        #status-update-btn:hover {
            background-color: #e74a3b;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 74, 59, 0.4);
        }

        #status-update-btn:active {
            transform: translateY(0);
        }

        /* Order Progress Step Styles */
        .order-progress-step.completed .progress-step-icon {
            background: var(--primary-red);
            color: white;
            border-color: var(--primary-red);
            box-shadow: 0 4px 15px rgba(231, 74, 59, 0.3);
        }

        .order-progress-step.completed .progress-step-label {
            color: var(--primary-red);
            font-weight: 600;
        }

        .order-progress-step.current .progress-step-icon {
            background: var(--primary-red);
            color: white;
            border-color: var(--primary-red);
            box-shadow: 0 4px 15px rgba(231, 74, 59, 0.3);
            animation: pulse 2s infinite;
        }

        .order-progress-step.current .progress-step-label {
            color: var(--primary-red);
            font-weight: 600;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Enhanced Mobile Responsiveness for All Tabs */
        @media (max-width: 768px) {
            /* Enhanced Order Tab Mobile Responsiveness */
            .order-card {
                margin-bottom: 15px !important;
                padding: 12px !important;
            }

            .order-card > div {
                flex-direction: column !important;
                gap: 12px !important;
                text-align: center;
            }

            .order-card img {
                width: 80px !important;
                height: 80px !important;
                margin: 0 auto !important;
            }

            .order-status-badge {
                font-size: 0.7rem !important;
                padding: 6px 10px !important;
                min-width: 60px !important;
            }

            .update-status-btn {
                width: 36px !important;
                height: 36px !important;
                margin: 0 auto !important;
            }

            /* Enhanced Products Tab Mobile Responsiveness */
            .admin-product-image {
                width: 60px !important;
                height: 60px !important;
                margin: 0 auto !important;
            }

            /* Enhanced Slider Tab Mobile Responsiveness */
            .admin-slider-image {
                width: 80px !important;
                height: 50px !important;
                margin: 0 auto !important;
            }

            /* Enhanced Messages Tab Mobile Responsiveness */
            .message-cell {
                text-align: center !important;
                padding: 8px !important;
            }

            /* Enhanced Order Progress Steps for Mobile */
            .order-progress-bar {
                display: flex;
                flex-direction: row;
                gap: 15px;
                align-items: center;
                justify-content: center;
                max-width: 350px;
            }

            .order-progress-step {
                flex-direction: column;
                text-align: center;
                min-width: 50px;
            }

            .progress-step-icon {
                margin-bottom: 8px;
            }

            .progress-step-label {
                font-size: 0.8rem;
            }

            /* Enhanced Modal Responsiveness */
            #order-details-modal .card {
                width: 95% !important;
                margin: 10px auto !important;
                padding: 20px !important;
                max-height: 85vh !important;
            }

            #order-details-modal .card > div {
                grid-template-columns: 1fr !important;
                gap: 20px !important;
            }

            #status-update-modal .card {
                width: 90% !important;
                margin: 20px auto !important;
                padding: 20px !important;
            }

            #product-manage-modal .card,
            #add-slider-image-modal .card {
                width: 95% !important;
                margin: 20px auto !important;
                padding: 20px !important;
            }

            /* Enhanced Table Container Responsiveness */
            #product-table-container,
            #order-table-container,
            #today-orders-container,
            #slider-image-table-container,
            #messages-table-container {
                overflow-x: hidden;
                padding: 0 5px;
            }
        }

        /* Extra Small Device Responsiveness */
        @media (max-width: 480px) {
            /* Extra small device order card adjustments */
            .order-card {
                padding: 10px !important;
            }

            .order-card img {
                width: 60px !important;
                height: 60px !important;
            }

            .order-status-badge {
                font-size: 0.65rem !important;
                padding: 4px 8px !important;
            }

            .update-status-btn {
                width: 32px !important;
                height: 32px !important;
            }

            /* Extra small device product image adjustments */
            .admin-product-image {
                width: 50px !important;
                height: 50px !important;
            }

            /* Extra small device slider image adjustments */
            .admin-slider-image {
                width: 60px !important;
                height: 40px !important;
            }
        }

        .progress-step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--surface-dark-color);
            color: var(--muted-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            transition: all 0.3s ease;
            border: 2px solid var(--border-color);
        }

        .progress-step-label {
            font-size: 0.8rem;
            color: var(--muted-color);
            font-weight: 500;
            text-align: center;
            transition: all 0.3s ease;
        }

        /* Base Order Progress Bar Styles */
        .order-progress-bar {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            position: relative;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .order-progress-bar::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 0px;
            background: transparent;
            z-index: 1;
        }

        .order-progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
            background: var(--surface-color);
            padding: 10px;
            border-radius: 8px;
        }

        /* Linear Progress Bar with Connected Steps */
        .order-progress-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 30px 0;
            position: relative;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
            padding: 0 20px;
        }

        .order-progress-bar::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50px;
            right: 50px;
            height: 4px;
            background: #e0e0e0;
            z-index: 1;
            transform: translateY(-50%);
            border-radius: 2px;
        }

        .order-progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
            background: transparent;
            padding: 8px;
            border-radius: 8px;
            min-width: 80px;
            text-align: center;
        }

        .progress-step-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #f5f5f5;
            color: #999;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            border: 4px solid #e0e0e0;
            position: relative;
            font-size: 1.2rem;
        }

        .progress-step-label {
            font-size: 0.75rem;
            color: #666;
            font-weight: 500;
            text-align: center;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        /* Active and Completed Step Styles */
        .order-progress-step.completed .progress-step-icon {
            background: var(--primary-red);
            color: white;
            border-color: var(--primary-red);
            box-shadow: 0 4px 15px rgba(231, 74, 59, 0.3);
        }

        .order-progress-step.completed .progress-step-label {
            color: var(--primary-red);
            font-weight: 600;
        }

        .order-progress-step.current .progress-step-icon {
            background: var(--primary-red);
            color: white;
            border-color: var(--primary-red);
            box-shadow: 0 4px 15px rgba(231, 74, 59, 0.3);
            animation: pulse 2s infinite;
        }

        .order-progress-step.current .progress-step-label {
            color: var(--primary-red);
            font-weight: 600;
        }

        /* Progress Line Fill */
        .order-progress-bar::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 30px;
            height: 0px;
            background: transparent;
            z-index: 1;
            transform: translateY(-50%);
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        /* Progress Line Fill for Different Statuses */
        .order-progress-bar[data-progress="25"]::after { width: 25%; }
        .order-progress-bar[data-progress="50"]::after { width: 50%; }
        .order-progress-bar[data-progress="75"]::after { width: 75%; }
        .order-progress-bar[data-progress="100"]::after { width: 100%; }

        /* Individual Circular Progress Steps - Clean Design */
        .order-progress-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 30px 0;
            position: relative;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
            padding: 0 20px;
            gap: 25px;
        }

        .order-progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
            background: transparent;
            padding: 4px;
            border-radius: 8px;
            min-width: 50px;
            text-align: center;
        }

        .progress-step-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #f5f5f5;
            color: #999;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 6px;
            transition: all 0.3s ease;
            border: 2px solid #e0e0e0;
            position: relative;
            font-size: 0.9rem;
        }

        .progress-step-label {
            font-size: 0.75rem;
            color: #666;
            font-weight: 500;
            text-align: center;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        /* Active and Completed Step Styles */
        .order-progress-step.completed .progress-step-icon {
            background: var(--primary-red);
            color: white;
            border-color: var(--primary-red);
            box-shadow: 0 4px 15px rgba(231, 74, 59, 0.3);
        }

        .order-progress-step.completed .progress-step-label {
            color: var(--primary-red);
            font-weight: 600;
        }

        .order-progress-step.current .progress-step-icon {
            background: var(--primary-red);
            color: white;
            border-color: var(--primary-red);
            box-shadow: 0 4px 15px rgba(231, 74, 59, 0.3);
            animation: pulse 2s infinite;
        }

        .order-progress-step.current .progress-step-label {
            color: var(--primary-red);
            font-weight: 600;
        }

        /* Enhanced Mobile Responsiveness for All Tabs */
    </style>
</head>
<body>
    <!-- Fixed Top Header -->
    <header class="admin-header">
        <div class="logo">
            <div class="theme-toggle-container" id="theme-toggle-container">
                <i class="fas fa-store theme-toggle-icon" style="color: var(--primary-red); font-size: 1.5rem; margin-right: 12px; cursor: pointer; transition: all 0.3s ease;" title="Toggle Dark/Light Mode"></i>
                <span style="font-weight: 700; font-size: 1.2rem; color: var(--text-color);">Chaudhary Kirana Store</span>
            </div>
        </div>
        <div class="admin-profile">
            <div class="admin-profile-container">
                <div class="admin-profile-info" id="admin-profile-info">
                    <i id="admin-shield-icon" class="fas fa-user-shield" style="color: var(--primary-red); font-size: 1.2rem; transition: color 0.3s ease; cursor: pointer;" title="Admin Profile"></i>
                    <span id="admin-name" style="color: var(--primary-red); font-weight: 600; margin-left: 8px; display: none;">Admin</span>
                </div>
                
                <!-- Admin Profile Dropdown -->
                <div class="admin-profile-dropdown" id="admin-profile-dropdown">
                    <div class="admin-profile-dropdown-content">
                        <div class="admin-profile-header">
                            <i class="fas fa-user-shield" style="color: var(--primary-red); font-size: 2rem; margin-bottom: 10px;"></i>
                            <div id="admin-dropdown-name" style="font-weight: 600; color: var(--text-color); margin-bottom: 5px;">Admin User</div>
                            <div id="admin-dropdown-email" style="color: var(--muted-color); font-size: 0.9rem;">admin@example.com</div>
                        </div>
                        <div class="admin-profile-actions">
                            <button class="admin-profile-action-btn" id="admin-profile-settings-btn">
                                <i class="fas fa-cog"></i> Profile Settings
                            </button>
                            <button class="admin-profile-action-btn" id="admin-logout-btn">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div id="admin-content-wrapper">
        <main class="admin-content" id="admin-content">

            <div class="container">


                <section id="products" class="admin-section">
                    <h2>Products</h2>
                    


                    <!-- Products Management Section -->
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; font-size: 1.2rem; font-weight: 600; color: var(--text-color);">Product List</h3>
                            <button id="add-product-btn" style="background-color: var(--primary-red); color: white; padding: 12px 20px; border-radius: 8px; font-weight: 600;">
                                <i class="fas fa-plus" style="margin-right: 8px;"></i>Add Product
                            </button>
                        </div>
                        <div id="product-table-container">
                            <!-- Product table will be loaded here -->
                            <p style="text-align: center; color: var(--muted-color);">No products to display.</p>
                        </div>
                        <div style="text-align: center; margin-top: 20px;">
                            <button onclick="addGroceryProducts()" id="add-grocery-btn" style="background-color: #28a745; color: white; padding: 15px 25px; border-radius: 12px; font-weight: 600; margin: 10px; border: none; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);">
                                <i class="fas fa-shopping-cart" style="margin-right: 10px; font-size: 1.2rem;"></i>
                                <span style="font-size: 1.1rem;">Add Grocery Products from Zepto</span>
                            </button>
                        </div>
                    </div>
                </section>

                <section id="orders" class="admin-section">
                    <h2>Orders</h2>
                    

                    
                    <!-- Orders Management Section -->
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; font-size: 1.2rem; font-weight: 600; color: var(--text-color);">Order List</h3>
                            <div style="display: flex; gap: 8px;">
                                <span style="color: var(--muted-color); font-size: 0.9rem;">All orders</span>
                            </div>
                        </div>
                        
                        <!-- Search Section -->
                        <div style="margin-bottom: 20px; padding: 15px; background: var(--surface-dark-color); border-radius: 12px; border: 1px solid var(--border-color);">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                                <i class="fas fa-search" style="color: var(--primary-red); font-size: 1.1rem;"></i>
                                <h4 style="margin: 0; font-size: 1rem; font-weight: 600; color: var(--text-color);">Search Orders</h4>
                            </div>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                                <div style="position: relative; flex: 1; min-width: 250px;">
                                    <input type="text" id="order-search-input" placeholder="Search by Order ID or Customer Name..." style="width: 100%; padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 0.9rem; background: white; transition: all 0.3s ease; box-sizing: border-box;">
                                </div>
                                <button id="order-clear-search-btn" style="background: var(--surface-dark-color); color: var(--muted-color); padding: 10px 16px; border: 2px solid var(--border-color); border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; white-space: nowrap; font-size: 0.9rem;">
                                    <i class="fas fa-times" style="margin-right: 6px;"></i>Clear
                                </button>
                            </div>
                            <div id="search-results-info" style="margin-top: 10px; font-size: 0.85rem; color: var(--muted-color); display: none;">
                                <!-- Search results info will be shown here -->
                            </div>
                        </div>
                        
                        <div id="order-table-container">
                            <!-- Order table will be loaded here -->
                            <p style="text-align: center; color: var(--muted-color);">No orders to display.</p>
                        </div>
                    </div>
                </section>

                <section id="today-orders" class="admin-section active">
                    <h2>Today Orders</h2>
                    

                    <!-- Today Orders Section -->
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; font-size: 1.2rem; font-weight: 600; color: var(--text-color);">Today's Order List</h3>
                            <div style="display: flex; gap: 8px;">
                                <span style="color: var(--muted-color); font-size: 0.9rem;">Orders placed today</span>
                            </div>
                        </div>
                        <div id="today-orders-container">
                            <!-- Today's orders will be loaded here -->
                            <p style="text-align: center; color: var(--muted-color);">No orders placed today.</p>
                        </div>
                    </div>
                </section>

                <section id="slider" class="admin-section">
                    <h2>Slider / Ad Management</h2>
                    
                    <!-- Slider Management Section -->
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; font-size: 1.2rem; font-weight: 600; color: var(--text-color);">Slider Images</h3>
                            <button id="add-slider-image-btn" style="background-color: #007bff; color: white; padding: 12px 20px; border-radius: 8px; font-weight: 600;">
                                <i class="fas fa-plus-circle" style="margin-right: 8px;"></i>Add New Slider Image
                            </button>
                    </div>
                        <div id="slider-image-table-container">
                        <!-- Slider image table will be loaded here -->
                        <p style="text-align: center; color: var(--muted-color);">No slider images to display.</p>
                        </div>
                    </div>
                </section>

                <section id="messages" class="admin-section">
                    <h2>Customer Messages</h2>
                    
                    <!-- Messages Management Section -->
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; font-size: 1.2rem; font-weight: 600; color: var(--text-color);">Message List</h3>
                            <div style="display: flex; gap: 8px;">
                                <span style="color: var(--muted-color); font-size: 0.9rem;">Customer inquiries and feedback</span>
                            </div>
                        </div>
                        <div id="messages-table-container">
                        <!-- Messages table will be loaded here -->
                        <p style="text-align: center; color: var(--muted-color);">No messages to display.</p>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <div id="sidebar-backdrop" class="sidebar-backdrop"></div>

    <!-- Message View Modal -->
    <div id="message-view-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index: 3000;">
        <div class="card" style="width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; padding: 30px; position: relative;">
            <button style="position: absolute; top: 10px; right: 10px; background: var(--primary-red); color: white; border: none; font-size: 1.2rem; cursor: pointer; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 1001;" onclick="document.getElementById('message-view-modal').style.display = 'none';">
                <i class="fas fa-times"></i>
            </button>
            <h3 style="margin-bottom: 20px; color: var(--text-color); margin-top: 10px;">Customer Message</h3>
            <div id="message-modal-content">
                <!-- Message details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="admin-auth-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index: 3000;">
        <div class="card" style="width: 90%; max-width: 400px; padding: 30px; text-align: center;">
            <h3>Admin Login</h3>
            <form id="admin-auth-form">
                <input type="email" id="admin-email" placeholder="Email" required style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid var(--border-color); border-radius: 8px;">
                <input type="password" id="admin-password" placeholder="Password" required style="width: 100%; padding: 10px; margin-bottom: 20px; border: 1px solid var(--border-color); border-radius: 8px;">
                <p id="admin-auth-error" style="color: var(--primary-red); margin-bottom: 15px; display: none;"></p>
                <button type="submit" id="admin-login-btn" style="background-color: var(--primary-red); color: white; width: 100%;"><i class="fas fa-sign-in-alt" style="margin-right: 5px;"></i>Login</button>
                
                <!-- Resend Verification Button (hidden by default) -->
                <button type="button" id="admin-resend-verification-btn" style="
                    background-color: #28a745; 
                    color: white; 
                    width: 100%; 
                    margin: 10px 0; 
                    display: none;
                    padding: 10px;
                    border: none;
                    border-radius: 8px;
                    font-size: 0.9rem;
                    cursor: pointer;
                ">
                    <i class="fas fa-envelope" style="margin-right: 8px;"></i>Resend Verification Email
                </button>
                
                <!-- Google Sign-In Button -->
                <div style="margin: 15px 0; text-align: center;">
                    <div style="margin-bottom: 10px; color: var(--muted-color); font-size: 0.9rem;">Or</div>
                    <button type="button" id="admin-google-signin-btn" style="
                        background-color: #4285f4; 
                        color: white; 
                        width: 100%; 
                        padding: 12px; 
                        border: none; 
                        border-radius: 8px; 
                        font-size: 1rem; 
                        cursor: pointer; 
                        display: flex; 
                        align-items: center; 
                        justify-content: center; 
                        gap: 10px;
                        transition: background-color 0.2s ease;
                    ">
                        <i class="fab fa-google" style="font-size: 1.1rem;"></i>
                        Sign in with Google
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Product Add/Edit Modal -->
    <div id="product-manage-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 2000;">
        <div class="card" style="width: 90%; max-width: 600px; padding: 30px; position: relative;">
            <button style="position: absolute; top: 10px; right: 10px; background: var(--primary-red); color: white; border: none; font-size: 1.2rem; cursor: pointer; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 1001;" onclick="document.getElementById('product-manage-modal').style.display = 'none';">
                <i class="fas fa-times"></i>
            </button>
            <h3 style="margin-top: 10px;">Add/Edit Product</h3>
            <form id="product-manage-form">
                <input type="text" id="product-name" placeholder="Product Name" required style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid var(--border-color); border-radius: 8px;">
                <input type="text" id="product-category" placeholder="Category" required style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid var(--border-color); border-radius: 8px;">
                <input type="number" id="product-price" placeholder="Price" step="0.01" required style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid var(--border-color); border-radius: 8px;">
                <input type="url" id="product-image-url" placeholder="Image URL" required style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid var(--border-color); border-radius: 8px;">
                <textarea id="product-description" placeholder="Description" rows="5" required style="width: 100%; padding: 10px; margin-bottom: 20px; border: 1px solid var(--border-color); border-radius: 8px;"></textarea>
                <button type="submit" style="background-color: var(--primary-red); color: white; width: 100%;"><i class="fas fa-save" style="margin-right: 5px;"></i>Save Product</button>
            </form>
        </div>
    </div>

    <!-- Add Slider Image Modal -->
    <div id="add-slider-image-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 2000;">
        <div class="card" style="width: 90%; max-width: 400px; padding: 30px; position: relative; text-align: center;">
            <button style="position: absolute; top: 10px; right: 10px; background: var(--primary-red); color: white; border: none; font-size: 1.2rem; cursor: pointer; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 1001;" onclick="document.getElementById('add-slider-image-modal').style.display = 'none';">
                <i class="fas fa-times"></i>
            </button>
            <h3 style="margin-top: 10px;">Add Slider Image</h3>
            <form id="add-slider-image-form">
                <input type="url" id="slider-image-url-input" placeholder="Image URL" required style="width: 100%; padding: 10px; margin-bottom: 20px; border: 1px solid var(--border-color); border-radius: 8px;">
                <button type="submit" style="background-color: var(--primary-red); color: white; width: 100%;"><i class="fas fa-plus-circle" style="margin-right: 5px;"></i>Add Image</button>
            </form>
        </div>
    </div>

    <!-- Order Details Full Screen Modal -->
    <div id="order-details-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); justify-content: center; align-items: center; z-index: 3000;">
        <div class="card" style="width: 95%; max-width: 800px; max-height: 90vh; overflow-y: auto; padding: 30px; position: relative;">
            <button class="icon-btn" style="position: absolute; top: 15px; right: 15px; font-size: 1.5rem; color: white; background: var(--primary-red); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;" onclick="document.getElementById('order-details-modal').style.display = 'none';">
                <i class="fas fa-times"></i>
            </button>
            
            <div id="order-details-content">
                <!-- Order details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Status Update Modal -->
    <div id="status-update-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 3000;">
        <div class="card" style="width: 90%; max-width: 400px; padding: 30px; position: relative; text-align: center;">
            <button class="modal-close-btn" style="position: absolute; top: 10px; right: 10px; width: 32px; height: 32px; border-radius: 50%; background: var(--primary-red); color: white; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.2rem; transition: all 0.2s ease;" onclick="document.getElementById('status-update-modal').style.display = 'none';">
                <i class="fas fa-times"></i>
            </button>
            <h3 style="color: var(--primary-red); margin-bottom: 20px;">Update Order Status</h3>
            <div style="margin-bottom: 20px;">
                <label for="status-update-select" style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-color);">Select New Status:</label>
                <select id="status-update-select" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem;">
                    <option value="Pending">Pending</option>
                    <option value="Processing">Processing</option>
                    <option value="Shipped">Shipped</option>
                    <option value="Delivered">Delivered</option>
                    <option value="Cancelled">Cancelled</option>
                </select>
            </div>
            <button id="status-update-btn" style="background-color: var(--primary-red); color: white; padding: 12px 24px; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; transition: all 0.2s ease;">
                Update Status
            </button>
        </div>
    </div>


    <script type="module">
        // Firebase Configuration (Placeholder)
const firebaseConfig = {
  apiKey: "AIzaSyDTSCG-mP_Atcgpg1-JKhAlKKLjNug-PZk",
  authDomain: "kirana-store-f55dd.firebaseapp.com",
  databaseURL: "https://kirana-store-f55dd-default-rtdb.firebaseio.com",
  projectId: "kirana-store-f55dd",
  storageBucket: "kirana-store-f55dd.firebasestorage.app",
  messagingSenderId: "584414364232",
  appId: "1:584414364232:web:1a89c8c6b293be45e30e7d"
};
        // Telegram Bot Configuration
        const TELEGRAM_BOT_TOKEN = '7119533193:AAGYRk2OO7D1xQAmeYeJA_FU7dPcrj35kGE';
        const TELEGRAM_CHAT_IDS = ['7298169399', '5744191135'];


        // Initialize Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, sendEmailVerification } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { getDatabase, ref, push, set, onValue, remove, update, onDisconnect } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";

        // --- Telegram Bot Integration for Admin ---
        // Function to send Telegram notification
        async function sendTelegramNotification(message) {
            try {
                for (const chatId of TELEGRAM_CHAT_IDS) {
                    const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            chat_id: chatId,
                            text: message,
                            parse_mode: 'HTML'
                        })
                    });
                    
                    if (!response.ok) {
                        console.error(`Failed to send Telegram notification to ${chatId}:`, response.statusText);
                    }
                }
            } catch (error) {
                console.error('Error sending Telegram notification:', error);
            }
        }

        // Function to send message to specific chat ID
        async function sendTelegramMessage(chatId, message) {
            try {
                const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: chatId,
                        text: message,
                        parse_mode: 'HTML'
                    })
                });
                
                if (!response.ok) {
                    console.error(`Failed to send Telegram message to ${chatId}:`, response.statusText);
                }
                return response.ok;
            } catch (error) {
                console.error('Error sending Telegram message:', error);
                return false;
            }
        }

        // Function to send order status update notification
        function sendOrderStatusUpdateNotification(orderData, oldStatus, newStatus) {
            try {
                // Validate input data
                if (!orderData || !orderData.orderId) {
                    console.error('Invalid order data for notification:', orderData);
                    return;
                }
                
                const orderId = orderData.orderId;
                const customerName = orderData.shippingName || 'Unknown Customer';
                const totalAmount = orderData.totalAmount || 0;
                const date = new Date().toLocaleString('en-IN');
            
            const statusEmojis = {
                'Pending': '',
                'Processing': '',
                'Shipped': '',
                'Delivered': '',
                'Cancelled': ''
            };
            
            const statusDescriptions = {
                'Pending': 'Order is pending and will be processed soon',
                'Processing': 'Order is being processed and prepared for shipping',
                'Shipped': 'Order has been shipped and is on its way',
                'Delivered': 'Order has been successfully delivered',
                'Cancelled': 'Order has been cancelled'
            };
            
            const emoji = statusEmojis[newStatus] || '';
            const description = statusDescriptions[newStatus] || 'Status updated';
            
            let message = `${emoji} <b>ORDER STATUS UPDATED!</b>\n\n`;
            message += ` <b>Order ID:</b> <code>${orderId}</code>\n`;
            message += ` <b>Customer:</b> ${customerName}\n`;
            message += ` <b>Total Amount:</b> ${totalAmount.toFixed(2)}\n`;
            message += ` <b>Update Date:</b> ${date}\n\n`;
            message += ` <b>Status Changed:</b>\n`;
            message += `From: ${oldStatus}  To: <b>${newStatus}</b>\n\n`;
            message += ` <b>Description:</b>\n${description}`;
            
                sendTelegramNotification(message);
            } catch (error) {
                console.error('Error sending order status update notification:', error);
            }
        }

        let app, auth, database;
        
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            database = getDatabase(app);
            
            // Initialize Google Auth Provider
            const googleProvider = new GoogleAuthProvider();
        } catch (error) {
            console.error('Firebase initialization failed:', error);
            showFallbackStats();
        }

        // Connection status indicator
        function updateConnectionStatus(connected) {
            const adminShieldIcon = document.getElementById('admin-shield-icon');
            
            if (adminShieldIcon) {
                if (connected) {
                    adminShieldIcon.style.color = '#28a745'; // Green for connected
                    adminShieldIcon.title = 'Admin Logged In - Click for Profile';
                } else {
                    adminShieldIcon.style.color = '#dc3545'; // Red for disconnected
                    adminShieldIcon.title = 'Not Connected - Please Login';
                }
            }
        }

        // Helper function to safely encode order data for HTML attributes
        function encodeOrderData(order) {
            try {
                // Validate the order object first
                if (!order || typeof order !== 'object') {
                    console.error('Invalid order object:', order);
                    return '';
                }
                
                // Check for required fields
                if (!order.orderId || !order.userId) {
                    console.error('Order missing required fields:', order);
                    return '';
                }
                
                // Instead of storing the entire order data, just store the order ID and user ID
                // This avoids HTML attribute length limitations and JSON parsing issues
                const minimalData = {
                    orderId: order.orderId,
                    userId: order.userId
                };
                
                const encoded = JSON.stringify(minimalData);
                console.log('Successfully encoded minimal order data:', minimalData);
                return encoded;
            } catch (error) {
                console.error('Error encoding order data:', error);
                // Return a safe fallback
                return '';
            }
        }

        // Helper function to decode order data from HTML attributes
        function decodeOrderData(encodedData) {
            try {
                if (!encodedData) {
                    console.warn('No encoded data provided to decodeOrderData');
                    return null;
                }
                
                // Parse the minimal data (just orderId and userId)
                const minimalData = JSON.parse(encodedData);
                console.log('Successfully parsed minimal order data:', minimalData);
                
                // If we have the minimal data, fetch the full order from the database
                if (minimalData.orderId && minimalData.userId) {
                    // Try to find the order in the current orders data
                    if (window.allOrders && 
                        window.allOrders[minimalData.userId] && 
                        window.allOrders[minimalData.userId][minimalData.orderId]) {
                        const fullOrder = window.allOrders[minimalData.userId][minimalData.orderId];
                        console.log('Found full order data for:', minimalData.orderId);
                        return fullOrder;
                    }
                    
                    // If not found in current data, return the minimal data for now
                    // The order details modal will need to handle this case
                    console.warn('Full order data not found, returning minimal data:', minimalData);
                    return minimalData;
                }
                
                console.warn('Minimal data missing required fields:', minimalData);
                return null;
            } catch (error) {
                console.error('Error decoding order data:', error);
                console.log('Raw encoded data length:', encodedData ? encodedData.length : 0);
                console.log('Raw encoded data preview:', encodedData ? encodedData.substring(0, 200) + '...' : 'null');
                return null;
            }
        }

        // Function to refresh all existing order cards to ensure proper encoding
        function refreshOrderCards() {
            console.log('Refreshing order cards to ensure proper encoding...');
            
            // Refresh main orders table
            if (window.allOrders) {
                renderOrderTable(window.allOrders);
            }
            
            // Refresh today's orders
            renderTodayOrders();
        }

        // Function to handle corrupted order data gracefully
        function handleCorruptedOrderData(card, error) {
            console.error('Handling corrupted order data:', error);
            
            // Show user-friendly error message
            card.innerHTML = `
                <div style="text-align: center; padding: 20px; color: var(--muted-color);">
                    <div style="font-size: 1.2rem; margin-bottom: 10px;"></div>
                    <div>This order data is corrupted</div>
                    <div style="font-size: 0.8rem; margin-top: 5px;">Click to remove</div>
                </div>
            `;
            
            // Make the card clickable to remove it
            card.style.cursor = 'pointer';
            card.onclick = () => {
                card.remove();
                console.log('User removed corrupted order card');
            };
        }

        // Function to validate order data integrity
        function validateOrderData(order) {
            if (!order) return false;
            
            const requiredFields = ['orderId', 'userId', 'shippingName', 'items', 'totalAmount', 'status', 'date'];
            const missingFields = requiredFields.filter(field => !order[field]);
            
            if (missingFields.length > 0) {
                console.warn('Order missing required fields:', missingFields);
                return false;
            }
            
            if (!Array.isArray(order.items) || order.items.length === 0) {
                console.warn('Order has invalid items array:', order.items);
                return false;
            }
            
            return true;
        }

        // Function to clean up corrupted order data
        function cleanupCorruptedOrders() {
            console.log('Cleaning up corrupted order data...');
            
            if (!database) {
                console.error('Database not available for cleanup');
                return;
            }
            
            // Listen to orders data to identify and fix corrupted entries
            onValue(ref(database, 'orders'), (snapshot) => {
                const allOrders = snapshot.val();
                if (!allOrders) return;
                
                let hasCorruptedData = false;
                
                for (const userId in allOrders) {
                    for (const orderId in allOrders[userId]) {
                        const order = allOrders[userId][orderId];
                        
                        // Check if order data is corrupted
                        if (!order || !order.orderId || !order.userId) {
                            console.warn('Found corrupted order, removing:', { userId, orderId, order });
                            hasCorruptedData = true;
                            
                            // Remove corrupted order
                            remove(ref(database, `orders/${userId}/${orderId}`));
                        }
                    }
                }
                
                if (hasCorruptedData) {
                    console.log('Cleaned up corrupted orders, refreshing display...');
                    setTimeout(() => {
                        refreshOrderCards();
                    }, 1000);
                }
            });
        }

        // --- Skeleton Loading Functions ---
        function showTableSkeleton(container, title, buttonText, rowCount = 5) {
            container.innerHTML = `
                <div class="skeleton-table">
                    <div class="skeleton-table-header">
                        <div class="skeleton skeleton-table-title"></div>
                        <div class="skeleton skeleton-table-button"></div>
                    </div>
                    ${Array(rowCount).fill(0).map(() => `
                        <div class="skeleton-table-row">
                            <div class="skeleton skeleton-table-image"></div>
                            <div class="skeleton skeleton-table-text"></div>
                            <div class="skeleton skeleton-table-text short"></div>
                            <div class="skeleton skeleton-table-text short"></div>
                            <div class="skeleton skeleton-table-actions"></div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function showStatsSkeleton() {
            const statsContainer = document.getElementById('stats-cards');
            const loadingIndicator = document.getElementById('loading-indicator');
            
            if (loadingIndicator) {
                loadingIndicator.style.display = 'block';
            }
            
            if (statsContainer) {
                statsContainer.innerHTML = `
                    <div class="skeleton-stats-card">
                        <div class="skeleton skeleton-stats-icon"></div>
                        <div class="skeleton skeleton-stats-number"></div>
                        <div class="skeleton skeleton-stats-label"></div>
                    </div>
                    <div class="skeleton-stats-card">
                        <div class="skeleton skeleton-stats-icon"></div>
                        <div class="skeleton skeleton-stats-number"></div>
                        <div class="skeleton skeleton-stats-label"></div>
                    </div>
                    <div class="skeleton-stats-card">
                        <div class="skeleton skeleton-stats-icon"></div>
                        <div class="skeleton skeleton-stats-number"></div>
                        <div class="skeleton skeleton-stats-label"></div>
                    </div>
                `;
            }
        }



        // --- Enhanced Image Loading for Admin ---
        function loadAdminImageWithFallback(imgElement, src, fallbackSrc = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiBmaWxsPSIjRjBGMEYwIi8+CjxwYXRoIGQ9Ik0yNSAyNUgxNVYxNUgyNVYyNVoiIGZpbGw9IiNDQ0NDQ0MiLz4KPC9zdmc+') {
            return new Promise((resolve) => {
                const img = new Image();
                
                // Add loading class
                imgElement.classList.add('admin-image-loading');
                
                img.onload = () => {
                    imgElement.src = src;
                    imgElement.classList.remove('admin-image-loading');
                    imgElement.classList.add('admin-image-loaded');
                    resolve();
                };
                
                img.onerror = () => {
                    imgElement.src = fallbackSrc;
                    imgElement.classList.remove('admin-image-loading');
                    imgElement.classList.add('admin-image-loaded');
                    resolve(); // Still resolve to continue
                };
                
                img.src = src;
            });
        }

        const adminContent = document.getElementById('admin-content');
        const adminContentWrapper = document.getElementById('admin-content-wrapper');



        // --- Admin Authentication (Re-enabled) ---
        document.addEventListener('DOMContentLoaded', () => {
            const adminAuthModal = document.getElementById('admin-auth-modal');
            const adminAuthForm = document.getElementById('admin-auth-form');
            const adminEmailInput = document.getElementById('admin-email');
            const adminPasswordInput = document.getElementById('admin-password');
            const adminAuthError = document.getElementById('admin-auth-error');
            const adminLoginBtn = document.getElementById('admin-login-btn'); // Get the login button
            const adminResendVerificationBtn = document.getElementById('admin-resend-verification-btn'); // Get the resend verification button

        // Add event listeners to hide resend button when user starts typing
        if (adminEmailInput && adminResendVerificationBtn) {
            adminEmailInput.addEventListener('input', () => {
                adminResendVerificationBtn.style.display = 'none';
            });
        }
        
        if (adminPasswordInput && adminResendVerificationBtn) {
            adminPasswordInput.addEventListener('input', () => {
                adminResendVerificationBtn.style.display = 'none';
            });
        }

            function showAdminAuthError(message) {
            adminAuthError.textContent = message;
            adminAuthError.style.display = 'block';
        }

            function hideAdminAuthError() {
            adminAuthError.textContent = '';
            adminAuthError.style.display = 'none';
            
            // Also hide the resend verification button when clearing errors
            if (adminResendVerificationBtn) {
                adminResendVerificationBtn.style.display = 'none';
            }
        }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // Check if user is verified (only for Email/Password users)
                    if (user.providerData[0]?.providerId === 'password' && !user.emailVerified) {
                        // Email/Password user is not verified, sign them out
                        signOut(auth);
                        return;
                    }
                    
                    // User is signed in and verified, hide login modal and show admin content
                    adminAuthModal.style.display = 'none';
                    adminContent.style.display = 'block';
                    adminContentWrapper.classList.remove('blur-overlay');
                    
                    // Update admin profile information
                    updateAdminProfile(user);

                    // Trigger initial stats fetch if on today-orders
                    if (window.location.hash === '#today-orders') {
                        // No dashboard stats needed
                    }
                } else {
                    // User is signed out, show login modal and hide admin content
                    adminAuthModal.style.display = 'flex';
                    adminContent.style.display = 'none';
                    adminContentWrapper.classList.add('blur-overlay');
                    
                    // Clear admin profile information
                    clearAdminProfile();
                }
            });

            adminAuthForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideAdminAuthError();

            const email = adminEmailInput.value;
            const password = adminPasswordInput.value;

            adminLoginBtn.disabled = true; // Disable button
            adminLoginBtn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 5px;"></i>Logging in...'; // Show loading indicator

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Check if email is verified for Email/Password users
                if (!user.emailVerified) {
                    // Sign out immediately if email is not verified
                    await signOut(auth);
                    showAdminAuthError(' Please verify your email before logging in. Check your inbox for the verification link.');
                    
                    // Show resend verification button
                    if (adminResendVerificationBtn) {
                        adminResendVerificationBtn.style.display = 'block';
                    }
                    return;
                }
                
                // Email is verified, proceed with login
                // Login successful, onAuthStateChanged will handle UI update
            } catch (error) {
                showAdminAuthError(error.message);
            } finally {
                adminLoginBtn.disabled = false; // Re-enable button
                adminLoginBtn.innerHTML = '<i class="fas fa-sign-in-alt" style="margin-right: 5px;"></i>Login'; // Restore original text
            }
        });
        
            // Set up Google Sign-In functionality for admin
            const adminGoogleSignInBtn = document.getElementById('admin-google-signin-btn');
        if (adminGoogleSignInBtn) {
            adminGoogleSignInBtn.addEventListener('click', async () => {
                try {
                    hideAdminAuthError();
                    
                    // Check if we're in a secure context (required for popup)
                    if (!window.isSecureContext && location.protocol !== 'https:' && location.hostname !== 'localhost') {
                        showAdminAuthError('Google Sign-In requires a secure connection (HTTPS) or localhost. Please use HTTPS or localhost for testing.');
                        return;
                    }
                    
                    const result = await signInWithPopup(auth, googleProvider);
                    const user = result.user;
                    
                                            // Check if this is a new user
                        if (result._tokenResponse?.isNewUser) {
                            // Save additional user data to Realtime Database for new Google users
                            const userProfileRef = ref(database, `users/${user.uid}/profile`);
                            await set(userProfileRef, {
                                email: user.email,
                                name: user.displayName || user.email.split('@')[0],
                                registrationDate: Date.now(),
                                authProvider: 'google',
                                emailVerified: true // Google accounts are pre-verified
                            });
                        }
                    
                    // Login successful, onAuthStateChanged will handle UI update
                } catch (error) {
                    console.error('Google Sign-In Error:', error);
                    if (error.code === 'auth/popup-closed-by-user') {
                        // User closed the popup - no error message needed
                    } else if (error.code === 'auth/unauthorized-domain') {
                        showAdminAuthError('This domain is not authorized for Google Sign-In. Please contact the administrator or use a different domain.');
                    } else if (error.code === 'auth/popup-blocked') {
                        showAdminAuthError('Google Sign-In popup was blocked. Please allow popups for this site and try again.');
                    } else {
                        showAdminAuthError(`Google Sign-In failed: ${error.message}`);
                    }
                }
            });
                }
        
            // Set up resend verification functionality for admin
            if (adminResendVerificationBtn) {
            adminResendVerificationBtn.addEventListener('click', async () => {
                try {
                    const email = adminEmailInput.value;
                    if (!email) {
                        showAdminAuthError('Please enter your email address first.');
                        return;
                    }
                    
                    // Try to sign in to get the user object
                    const userCredential = await signInWithEmailAndPassword(auth, email, adminPasswordInput.value);
                    const user = userCredential.user;
                    
                    // Send verification email
                    await sendEmailVerification(user);
                    
                    // Sign out immediately
                    await signOut(auth);
                    
                    // Show success message
                    showAdminAuthError(' Verification email resent! Please check your inbox.');
                    
                    // Hide the resend button
                    adminResendVerificationBtn.style.display = 'none';
                } catch (error) {
                    if (error.code === 'auth/user-not-found') {
                        showAdminAuthError('User not found. Please check your email address.');
                    } else if (error.code === 'auth/wrong-password') {
                        showAdminAuthError('Wrong password. Please check your credentials.');
                    } else if (error.code === 'auth/too-many-requests') {
                        showAdminAuthError('Too many attempts. Please try again later.');
                    } else {
                        showAdminAuthError(`Failed to resend verification: ${error.message}`);
                    }
                }
            });
        }
        
        function handleAdminLogout() {
            signOut(auth).then(() => {
                // Sign-out successful, onAuthStateChanged will handle UI update
                window.location.hash = '#today-orders'; // Redirect to today orders after logout
                document.body.classList.remove('sidebar-open-mobile'); // Ensure body overflow is reset
                sidebarBackdrop.classList.remove('active'); // Hide backdrop
            }).catch((error) => {
                console.error("Logout Error:", error);
                // Logout failed - no alert needed
            });
        }
        



        // Time period button functionality
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('time-btn')) {
                // Remove active class from all buttons in the same group
                const buttonGroup = e.target.closest('div');
                buttonGroup.querySelectorAll('.time-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                // Add active class to clicked button
                e.target.classList.add('active');
                
                // Get the selected period and filter orders
                const selectedPeriod = e.target.getAttribute('data-period');
                filterOrdersByPeriod(selectedPeriod);
            }
        });

        // Filter orders by time period
        function filterOrdersByPeriod(period) {
            if (!database) return;
            
            const ordersRef = ref(database, 'orders');
            onValue(ordersRef, (snapshot) => {
                const orders = snapshot.val();
                if (orders) {
                    const filteredOrders = filterOrders(orders, period);
                    renderOrderTable(filteredOrders);
                }
            });
        }

        // Filter orders based on time period
        function filterOrders(orders, period) {
            const now = new Date();
            const filtered = {};
            
            Object.keys(orders).forEach(orderId => {
                const order = orders[orderId];
                const orderDate = new Date(order.timestamp || order.orderDate || now);
                
                let shouldInclude = false;
                
                switch (period) {
                    case 'daily':
                        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        shouldInclude = orderDate >= today;
                        break;
                    case 'weekly':
                        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        shouldInclude = orderDate >= weekAgo;
                        break;
                    case 'monthly':
                        const monthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
                        shouldInclude = orderDate >= monthAgo;
                        break;
                    default:
                        shouldInclude = true;
                }
                
                if (shouldInclude) {
                    filtered[orderId] = order;
                }
            });
            
            return filtered;
        }

        // --- SPA Routing Logic ---
        const adminRoutes = {
            '#dashboard': 'dashboard',
            '#products': 'products',
            '#orders': 'orders',
            '#today-orders': 'today-orders',
            '#slider': 'slider',
            '#messages': 'messages',
            '#logout': 'logout' // Special case for logout
        };

        function showAdminSection(sectionId) {
            document.querySelectorAll('.admin-section').forEach(section => {
                section.classList.remove('active');
            });
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
            }
        }

        function handleAdminHashChange() {
            const hash = window.location.hash || '#today-orders';
            const route = adminRoutes[hash];

            // Ensure bottom navigation is always visible
            const bottomNav = document.querySelector('.admin-bottom-nav');
            if (bottomNav) {
                bottomNav.style.display = 'flex';
                bottomNav.style.zIndex = '9999';
            }

            // Update bottom navigation
            document.querySelectorAll('.admin-nav-item').forEach(item => {
                item.classList.remove('active');
            });

            if (route) {
                if (route === 'logout') {
                    handleAdminLogout();
                    return;
                }
                showAdminSection(route);
                const activeNavItem = document.querySelector(`.admin-nav-item[data-route="${route}"]`);
                if (activeNavItem) {
                    activeNavItem.classList.add('active');
                }
            } else {
                window.location.hash = '#today-orders';
            }
        }

        window.addEventListener('hashchange', handleAdminHashChange);
        window.addEventListener('load', handleAdminHashChange);



        // --- Dashboard Stats ---
        const totalProductsSpan = document.getElementById('total-products');
        const totalOrdersSpan = document.getElementById('total-orders');
        const totalMessagesSpan = document.getElementById('total-messages');

        

        

        // Handle navigation changes
        window.addEventListener('hashchange', () => {
            if (window.location.hash === '#today-orders') {
                renderTodayOrders();
            }
        });

        // Handle hash changes for navigation
        window.addEventListener('hashchange', () => {
            const hash = window.location.hash.substring(1); // Remove the #
            if (hash) {
                showSection(hash);
                
                // Load specific content based on section
                if (hash === 'today-orders') {
                    renderTodayOrders();
                } else if (hash === 'products') {
                    // Products will be loaded automatically via Firebase listener
                } else if (hash === 'orders') {
                    // Load all orders when navigating to orders section
                    onValue(ref(database, 'orders'), (snapshot) => {
                        const allOrders = snapshot.val() || {};
                        renderOrderTable(allOrders);
                    }, { onlyOnce: true });
                } else if (hash === 'slider') {
                    // Slider will be loaded automatically via Firebase listener
                } else if (hash === 'messages') {
                    // Messages will be loaded automatically via Firebase listener
                }
            }
        });

        // Initial load - show correct section by default
        window.addEventListener('load', () => {
            // Ensure bottom navigation is always visible
            const bottomNav = document.querySelector('.admin-bottom-nav');
            if (bottomNav) {
                bottomNav.style.display = 'flex';
                bottomNav.style.zIndex = '9999';
            }

            // Show today's orders by default if no hash
            if (!window.location.hash) {
                showSection('today-orders');
                setTimeout(() => {
                    renderTodayOrders();
                }, 100);
            } else {
                // Show the section based on current hash
                const hash = window.location.hash.substring(1);
                showSection(hash);
                
                if (hash === 'today-orders') {
                    setTimeout(() => {
                        renderTodayOrders();
                    }, 100);
                } else if (hash === 'orders') {
                    setTimeout(() => {
                        onValue(ref(database, 'orders'), (snapshot) => {
                            const allOrders = snapshot.val() || {};
                            renderOrderTable(allOrders);
                        }, { onlyOnce: true });
                    }, 100);
                }
            }
        });

        // Monitor Firebase connection status
        if (database) {
            const connectedRef = ref(database, '.info/connected');
            onValue(connectedRef, (snapshot) => {
                updateConnectionStatus(snapshot.val());
            });
        } else {
            updateConnectionStatus(false);
        }



        }); // Close Admin Authentication DOMContentLoaded

        // Global admin functions that need to be accessible from other parts
        function handleAdminLogout() {
            signOut(auth).then(() => {
                // Sign-out successful, onAuthStateChanged will handle UI update
                window.location.hash = '#today-orders'; // Redirect to today orders after logout
                document.body.classList.remove('sidebar-open-mobile'); // Ensure body overflow is reset
                if (typeof sidebarBackdrop !== 'undefined') {
                    sidebarBackdrop.classList.remove('active'); // Hide backdrop
                }
            }).catch((error) => {
                console.error("Logout Error:", error);
                // Logout failed - no alert needed
            });
        }

        // Function to update admin profile information
        function updateAdminProfile(user) {
            const adminName = document.getElementById('admin-name');
            const adminDropdownName = document.getElementById('admin-dropdown-name');
            const adminDropdownEmail = document.getElementById('admin-dropdown-email');
            
            if (adminName) {
                adminName.textContent = user.displayName || user.email.split('@')[0];
                adminName.style.display = 'inline';
            }
            
            if (adminDropdownName) {
                adminDropdownName.textContent = user.displayName || user.email.split('@')[0];
            }
            
            if (adminDropdownEmail) {
                adminDropdownEmail.textContent = user.email;
            }
            
            // Update connection status to show admin is logged in
            updateConnectionStatus(true);
        }
        
        // Function to clear admin profile information
        function clearAdminProfile() {
            const adminName = document.getElementById('admin-name');
            const adminDropdownName = document.getElementById('admin-dropdown-name');
            const adminDropdownEmail = document.getElementById('admin-dropdown-email');
            
            if (adminName) {
                adminName.style.display = 'none';
            }
            
            if (adminDropdownName) {
                adminDropdownName.textContent = 'Admin User';
            }
            
            if (adminDropdownEmail) {
                adminDropdownEmail.textContent = 'admin@example.com';
            }
            
            // Update connection status to show admin is logged out
            updateConnectionStatus(false);
        }
        
        // Theme functionality
        function initializeTheme() {
            // Load saved theme from localStorage
            const savedTheme = localStorage.getItem('admin-theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }
        
        function updateThemeIcon(theme) {
            const themeToggleIcon = document.querySelector('.theme-toggle-icon');
            if (themeToggleIcon) {
                if (theme === 'dark') {
                    themeToggleIcon.title = 'Switch to Light Mode';
                    // You can change the icon here if you want
                } else {
                    themeToggleIcon.title = 'Switch to Light Mode';
                    // You can change the icon here if you want
                }
            }
        }

        // --- Stat Card Click Handlers ---
        document.addEventListener('DOMContentLoaded', () => {
            const statCards = document.querySelectorAll('.stat-card');
            statCards.forEach(card => {
                card.addEventListener('click', () => {
                    const redirectUrl = card.dataset.redirect;
                    if (redirectUrl) {
                        window.location.hash = redirectUrl;
                    }
                });
            });

            // --- Bottom Navigation Click Handlers ---
            const bottomNavItems = document.querySelectorAll('.admin-nav-item');
            bottomNavItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    // Get the route from data attribute
                    const route = item.getAttribute('data-route');
                    if (route) {
                        showSection(route);
                        window.location.hash = `#${route}`;
                    }
                });
            });
            
            // --- Admin Profile Dropdown Functionality ---
            const adminProfileInfo = document.getElementById('admin-profile-info');
            const adminProfileDropdown = document.getElementById('admin-profile-dropdown');
            const adminProfileSettingsBtn = document.getElementById('admin-profile-settings-btn');
            const adminLogoutBtn = document.getElementById('admin-logout-btn');
            
            // --- Theme Toggle Functionality ---
            const themeToggleIcon = document.querySelector('.theme-toggle-icon');
            
            // Initialize theme functionality
            initializeTheme();
            
            // Refresh order cards to ensure proper encoding
            setTimeout(() => {
                refreshOrderCards();
            }, 1000); // Wait 1 second for data to load
            
            // Clean up any corrupted order data
            setTimeout(() => {
                cleanupCorruptedOrders();
            }, 2000); // Wait 2 seconds for data to load
            
            if (themeToggleIcon) {
                themeToggleIcon.addEventListener('click', () => {
                    const currentTheme = document.documentElement.getAttribute('data-theme');
                    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                    
                    document.documentElement.setAttribute('data-theme', newTheme);
                    localStorage.setItem('admin-theme', newTheme);
                    updateThemeIcon(newTheme);
                });
            }
            
            // Toggle dropdown on profile click
            if (adminProfileInfo && adminProfileDropdown) {
                adminProfileInfo.addEventListener('click', (e) => {
                    e.stopPropagation();
                    adminProfileDropdown.classList.toggle('show');
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!adminProfileInfo.contains(e.target) && !adminProfileDropdown.contains(e.target)) {
                        adminProfileDropdown.classList.remove('show');
                    }
                });
            }
            
            // Profile settings button
            if (adminProfileSettingsBtn) {
                adminProfileSettingsBtn.addEventListener('click', () => {
                    adminProfileDropdown.classList.remove('show');
                    // You can add profile settings functionality here
                    console.log('Profile settings clicked');
                });
            }
            
            // Admin logout button
            if (adminLogoutBtn) {
                adminLogoutBtn.addEventListener('click', () => {
                    adminProfileDropdown.classList.remove('show');
                    handleAdminLogout();
                });
            }
        });


        const forceShowStatsBtn = document.getElementById('force-show-stats-btn');

        // Force show stats button removed as dashboard is no longer needed







        // --- Product Management (CRUD) ---
        const addProductBtn = document.getElementById('add-product-btn');
        const productManageModal = document.getElementById('product-manage-modal');
        const productManageForm = document.getElementById('product-manage-form');
        const productNameInput = document.getElementById('product-name');
        const productCategoryInput = document.getElementById('product-category');
        const productPriceInput = document.getElementById('product-price');
        const productImageUrlInput = document.getElementById('product-image-url');
        const productDescriptionTextarea = document.getElementById('product-description');

        let editingProductId = null; // To store the ID of the product being edited

        // Add grocery products from Zepto
        const groceryProducts = [
            // Fruits & Vegetables
            { name: "Fresh Apples", price: 120, imageUrl: "https://images.unsplash.com/photo-1560806887-1e4cd0b6cbd6?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh and juicy apples, perfect for healthy snacking.", category: "Fruits & Vegetables" },
            { name: "Organic Bananas", price: 60, imageUrl: "https://images.unsplash.com/photo-1571771894821-ce9b6c11b08e?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Organic bananas, rich in potassium and natural sweetness.", category: "Fruits & Vegetables" },
            { name: "Fresh Strawberries", price: 180, imageUrl: "https://images.unsplash.com/photo-1464965911861-746a04b4bca6?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Sweet and juicy strawberries, perfect for desserts.", category: "Fruits & Vegetables" },
            { name: "Fresh Pomegranate", price: 140, imageUrl: "https://images.unsplash.com/photo-1541344999737-9c6c2c7e1a3b?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh pomegranate seeds, rich in antioxidants.", category: "Fruits & Vegetables" },
            { name: "Fresh Beetroot", price: 80, imageUrl: "https://images.unsplash.com/photo-1578662996442-48f60103fc96?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh beetroot, perfect for salads and juices.", category: "Fruits & Vegetables" },
            { name: "Fresh Ash Gourd", price: 45, imageUrl: "https://images.unsplash.com/photo-1578662996442-48f60103fc96?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh ash gourd, great for cooking and health benefits.", category: "Fruits & Vegetables" },
            { name: "Fresh Bottle Gourd", price: 35, imageUrl: "https://images.unsplash.com/photo-1578662996442-48f60103fc96?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh bottle gourd, excellent for weight loss.", category: "Fruits & Vegetables" },
            { name: "Fresh Lady Finger", price: 60, imageUrl: "https://images.unsplash.com/photo-1578662996442-48f60103fc96?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh lady finger, perfect for curries and stir-fries.", category: "Fruits & Vegetables" },
            { name: "Fresh Potatoes", price: 40, imageUrl: "https://images.unsplash.com/photo-1578662996442-48f60103fc96?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh potatoes, versatile for various dishes.", category: "Fruits & Vegetables" },
            { name: "Fresh Lemons", price: 50, imageUrl: "https://images.unsplash.com/photo-1578662996442-48f60103fc96?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh lemons, great for cooking and beverages.", category: "Fruits & Vegetables" },
            { name: "Fresh Blueberries", price: 220, imageUrl: "https://images.unsplash.com/photo-1498557850523-fd3d118b962e?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh blueberries, rich in antioxidants and vitamins.", category: "Fruits & Vegetables" },
            { name: "Fresh Papaya", price: 90, imageUrl: "https://images.unsplash.com/photo-1578662996442-48f60103fc96?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh papaya, great for digestion and health.", category: "Fruits & Vegetables" },
            { name: "Fresh Dragon Fruit", price: 150, imageUrl: "https://images.unsplash.com/photo-1578662996442-48f60103fc96?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh dragon fruit, exotic and nutritious.", category: "Fruits & Vegetables" },
            { name: "Fresh Mushroom", price: 120, imageUrl: "https://images.unsplash.com/photo-1578662996442-48f60103fc96?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh mushrooms, perfect for cooking and health.", category: "Fruits & Vegetables" },
            { name: "Fresh Lettuce", price: 70, imageUrl: "https://images.unsplash.com/photo-1578662996442-48f60103fc96?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh lettuce, perfect for salads and sandwiches.", category: "Fruits & Vegetables" },
            { name: "Fresh Avocado", price: 200, imageUrl: "https://images.unsplash.com/photo-1578662996442-48f60103fc96?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh avocado, rich in healthy fats and nutrients.", category: "Fruits & Vegetables" },
            // Dairy & Bread
            { name: "Amul Butter", price: 55, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh Amul butter, perfect for cooking and spreading.", category: "Dairy & Bread" },
            { name: "Cheese Slices", price: 120, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh cheese slices, great for sandwiches and burgers.", category: "Dairy & Bread" },
            { name: "Fresh Milk", price: 65, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh milk, rich in calcium and nutrients.", category: "Dairy & Bread" },
            { name: "Fresh Curd", price: 45, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh curd, perfect for raita and lassi.", category: "Dairy & Bread" },
            { name: "Fresh Eggs", price: 80, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh eggs, rich in protein and nutrients.", category: "Dairy & Bread" },
            { name: "Fresh Bread", price: 35, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh bread, perfect for sandwiches and toast.", category: "Dairy & Bread" },
            // Grocery Essentials
            { name: "Aashirvaad Atta", price: 55, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Premium quality wheat flour for rotis and breads.", category: "Grocery Essentials" },
            { name: "Basmati Rice", price: 120, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Premium basmati rice, long grain and aromatic.", category: "Grocery Essentials" },
            { name: "Refined Oil", price: 140, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Pure refined oil for cooking and frying.", category: "Grocery Essentials" },
            { name: "Toor Dal", price: 85, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh toor dal, perfect for sambhar and dal.", category: "Grocery Essentials" },
            { name: "Masoor Dal", price: 75, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh masoor dal, great for soups and curries.", category: "Grocery Essentials" },
            // Snacks & Beverages
            { name: "Lays Chips", price: 20, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Crunchy Lays chips, perfect for snacking.", category: "Snacks & Beverages" },
            { name: "Kurkure", price: 10, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Spicy Kurkure, great for evening snacks.", category: "Snacks & Beverages" },
            { name: "Apple Juice", price: 45, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh apple juice, rich in vitamins.", category: "Snacks & Beverages" },
            { name: "Chocolate Box", price: 150, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Assorted chocolate box, perfect for gifting.", category: "Snacks & Beverages" },
            { name: "Cold Coffee", price: 80, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Refreshing cold coffee, perfect for summers.", category: "Snacks & Beverages" },
            // Spices & Masala
            { name: "Dalchini (Cinnamon)", price: 25, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh dalchini for aromatic cooking.", category: "Spices & Masala" },
            { name: "Fennel Seeds", price: 30, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh fennel seeds for mouth freshener.", category: "Spices & Masala" },
            { name: "Turmeric Powder", price: 40, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Pure turmeric powder for cooking.", category: "Spices & Masala" },
            { name: "Red Chili Powder", price: 35, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Spicy red chili powder for heat.", category: "Spices & Masala" },
            { name: "Garam Masala", price: 45, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Aromatic garam masala blend.", category: "Spices & Masala" },
            // Personal Care
            { name: "Toothpaste", price: 65, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh mint toothpaste for oral hygiene.", category: "Personal Care" },
            { name: "Soap", price: 35, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Gentle soap for daily use.", category: "Personal Care" },
            { name: "Shampoo", price: 85, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Nourishing shampoo for healthy hair.", category: "Personal Care" },
            // Household Items
            { name: "Detergent Powder", price: 120, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Powerful detergent for clean clothes.", category: "Household Items" },
            { name: "Dish Soap", price: 55, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Effective dish soap for clean utensils.", category: "Household Items" },
            { name: "Toilet Paper", price: 75, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Soft toilet paper for comfort.", category: "Household Items" }
        ];

        // Function to add all grocery products to database
        async function addGroceryProducts() {
            try {
                const productsRef = ref(database, 'products');
                let addedCount = 0;
                
                for (const product of groceryProducts) {
                    const newProductRef = push(productsRef);
                    await set(newProductRef, product);
                    addedCount++;
                }
                
                // Products added successfully - no alert needed
                fetchProducts(); // Refresh product list
            } catch (error) {
                console.error("Error adding grocery products:", error);
                // Error adding products - no alert needed
            }
        }

        function renderProductTable(products) {
            const productTableContainer = document.getElementById('product-table-container');
            if (Object.keys(products).length === 0) {
                productTableContainer.innerHTML = '<p style="text-align: center; color: var(--muted-color);">No products to display.</p>';
                return;
            }

            let tableHtml = `
                <table style="width: 100%; border-collapse: collapse; text-align: left;">
                    <thead>
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <th style="padding: 10px;">Image</th>
                            <th style="padding: 10px;">Name</th>
                            <th style="padding: 10px;">Category</th>
                            <th style="padding: 10px;">Price</th>
                            <th style="padding: 10px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            for (const productId in products) {
                const product = products[productId];
                tableHtml += `
                    <tr style="border-bottom: 1px solid var(--border-color);">
                        <td data-label="Image:" style="padding: 10px;"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='50' height='50'%3E%3Crect width='100%25' height='100%25' fill='%23f0f0f0'/%3E%3C/svg%3E" alt="${product.name}" class="admin-product-image" data-src="${product.imageUrl || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiBmaWxsPSIjRjBGMEYwIi8+CjxwYXRoIGQ9Ik0yNSAyNUgxNVYxNUgyNVYyNVoiIGZpbGw9IiNDQ0NDQ0MiLz4KPC9zdmc+'}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;"></td>
                        <td data-label="Name:" style="padding: 10px;">${product.name}</td>
                        <td data-label="Category:" style="padding: 10px;">${product.category}</td>
                        <td data-label="Price:" style="padding: 10px;">${product.price.toFixed(2)}</td>
                        <td data-label="Actions:" style="padding: 10px; text-align: center;">
                            <button class="icon-btn edit-product-btn" data-product-id="${productId}" style="color: #007bff;"><i class="fas fa-edit"></i></button>
                            <button class="icon-btn delete-product-btn" data-product-id="${productId}" style="color: var(--primary-red); margin-left: 5px;"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            }

            tableHtml += `
                    </tbody>
                </table>
            `;
            productTableContainer.innerHTML = tableHtml;

            // Load images with enhanced loading
            productTableContainer.querySelectorAll('.admin-product-image').forEach(img => {
                const imageSrc = img.getAttribute('data-src');
                if (imageSrc) {
                    loadAdminImageWithFallback(img, imageSrc);
                }
            });

                    // Add event listeners for edit and delete buttons
        productTableContainer.querySelectorAll('.edit-product-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                openEditProductModal(e.currentTarget.dataset.productId, products[e.currentTarget.dataset.productId]);
            });
        });

        productTableContainer.querySelectorAll('.delete-product-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                deleteProduct(e.currentTarget.dataset.productId);
            });
        });
        }

        addProductBtn.addEventListener('click', () => {
            editingProductId = null;
            productManageForm.reset();
            productManageModal.style.display = 'flex';
        });

        function openEditProductModal(productId, product) {
            editingProductId = productId;
            productNameInput.value = product.name;
            productCategoryInput.value = product.category;
            productPriceInput.value = product.price;
            productImageUrlInput.value = product.imageUrl;
            productDescriptionTextarea.value = product.description;
            productManageModal.style.display = 'flex';
        }

        productManageForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const productData = {
                name: productNameInput.value,
                category: productCategoryInput.value,
                price: parseFloat(productPriceInput.value),
                imageUrl: productImageUrlInput.value,
                description: productDescriptionTextarea.value,
            };

            const productsRef = ref(database, 'products');

            if (editingProductId) {
                // Update existing product
                const productRef = ref(database, `products/${editingProductId}`);
                await update(productRef, productData);
            } else {
                // Add new product
                const newProductRef = push(productsRef);
                await set(newProductRef, productData);
            }
            productManageModal.style.display = 'none';
            productManageForm.reset();
        });

        async function deleteProduct(productId) {
            // Product deletion confirmed - no confirm dialog needed
                const productRef = ref(database, `products/${productId}`);
                await remove(productRef);
        }

        // Show skeleton loading initially for products
        const productTableContainer = document.getElementById('product-table-container');
        if (productTableContainer) {
            showTableSkeleton(productTableContainer, 'Products', 'Add Product', 6);
        }

        // Listen for product changes to re-render the table
        onValue(ref(database, 'products'), (snapshot) => {
            const products = snapshot.val() || {};
            renderProductTable(products);
        });

        // Refresh product table when navigating to the products section
        window.addEventListener('hashchange', () => {
            if (window.location.hash === '#products') {
                onValue(ref(database, 'products'), (snapshot) => {
                    const products = snapshot.val() || {};
                    renderProductTable(products);
                }, { onlyOnce: true });
            }
        });

        // --- Order Management ---
        const orderTableContainer = document.getElementById('order-table-container');
        const orderSearchInput = document.getElementById('order-search-input');
        const orderSearchBtn = document.getElementById('order-search-btn');
        const orderClearSearchBtn = document.getElementById('order-clear-search-btn');
        const searchResultsInfo = document.getElementById('search-results-info');
        
        let allOrders = {}; // Store all orders for search functionality
        let filteredOrders = {}; // Store filtered orders

        function renderOrderProducts(items) {
            if (!items || !Array.isArray(items) || items.length === 0) {
                return '<span style="color: var(--muted-color); font-size: 0.85rem;">No items</span>';
            }
            
            let productsHtml = '';
            items.forEach((item, index) => {
                const imageUrl = item.imageUrl || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0yMCAyNEMyMi4wOTExIDI0IDI0IDIyLjA5MTEgMjQgMjBDMjQgMTcuOTA4OSAyMi4wOTExIDE2IDIwIDE2QzE3LjkwODkgMTYgMTYgMTcuOTA4OSAxNiAyMEMxNiAyMi4wOTExIDE3LjkwODkgMjQgMjAgMjRaIiBmaWxsPSIjQ0NDIi8+CjxwYXRoIGQ9Ik0yMCAyOEMyNC40MTgzIDI4IDI4IDI0LjQxODMgMjggMjBIMTJDMTIgMjQuNDE4MyAxNS41ODE3IDI4IDIwIDI4WiIgZmlsbD0iI0NDQyIvPgo8L3N2Zz4K';
                const productName = item.name || 'Unknown Product';
                const quantity = item.qty || 1;
                
                productsHtml += `
                    <div style="display: flex; align-items: center; margin-bottom: ${index < items.length - 1 ? '10px' : '0'}; padding: 4px 0;">
                        <img src="${imageUrl}" alt="${productName}" style="width: 32px; height: 32px; border-radius: 6px; object-fit: cover; margin-right: 10px; flex-shrink: 0; border: 1px solid var(--border-color);">
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 500; font-size: 0.9rem; color: var(--text-color); line-height: 1.2; margin-bottom: 2px; word-wrap: break-word; max-width: 130px;" title="${productName}">${productName}</div>
                            <div style="font-size: 0.8rem; color: var(--muted-color); font-weight: 500;">Qty: ${quantity}</div>
                        </div>
                    </div>
                `;
            });
            
            return productsHtml;
        }

        function getStatusColor(status) {
            switch(status) {
                case 'Pending': return '#ffc107';
                case 'Processing': return '#17a2b8';
                case 'Shipped': return '#007bff';
                case 'Delivered': return '#28a745';
                case 'Cancelled': return '#dc3545';
                default: return '#6c757d';
            }
        }

        function renderOrderTable(allOrders) {
            if (!allOrders || Object.keys(allOrders).length === 0) {
                orderTableContainer.innerHTML = '<p style="text-align: center; color: var(--muted-color);">No orders to display.</p>';
                return;
            }
            
            // Store all orders for search functionality
            window.allOrders = allOrders;

            let tableHtml = `
                <div style="display: grid; gap: 15px; padding: 10px; margin-top: 10px;">
            `;

            const ordersArray = [];
            for (const userId in allOrders) {
                for (const orderId in allOrders[userId]) {
                    ordersArray.push({ userId, ...allOrders[userId][orderId] });
                }
            }

            // Sort orders by date (most recent first)
            ordersArray.sort((a, b) => b.date - a.date);

            ordersArray.forEach(order => {
                // Validate order data before rendering
                if (!validateOrderData(order)) {
                    console.warn('Skipping invalid order:', { userId: order.userId, orderId: order.orderId, order });
                    return; // Skip this order
                }
                
                const orderDate = new Date(order.date).toLocaleDateString();
                const firstProduct = order.items && order.items.length > 0 ? order.items[0] : null;
                const productImage = firstProduct ? (firstProduct.imageUrl || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0yMCAyNEMyMi4wOTExIDI0IDI0IDIyLjA5MTEgMjQgMjBDMjQgMTcuOTA4OSAyMi4wOTExIDE2IDIwIDE2QzE3LjkwODkgMTYgMTYgMTcuOTA4OSAxNiAyMEMxNiAyMi4wOTExIDE3LjkwODkgMjQgMjAgMjRaIiBmaWxsPSIjQ0NDIi8+CjxwYXRoIGQ9Ik0yMCAyOEMyNC40MTgzIDI4IDI4IDI0LjQxODMgMjggMjBIMTJDMTIgMjQuNDE4MyAxNS41ODE3IDI4IDIwIDI4WiIgZmlsbD0iI0NDQyIvPgo8L3N2Zz4K') : 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0yMCAyNEMyMi4wOTExIDI0IDI0IDIyLjA5MTEgMjQgMjBDMjQgMTcuOTA4OSAyMi4wOTExIDE2IDIwIDE2QzE3LjkwODkgMTYgMTYgMTcuOTA4OSAxNiAyMEMxNiAyMi4wOTExIDE3LjkwODkgMjQgMjAgMjRaIiBmaWxsPSIjQ0NDIi8+CjxwYXRoIGQ9Ik0yMCAyOEMyNC40MTgzIDI4IDI4IDI0LjQxODMgMjggMjBIMTJDMTIgMjQuNDE4MyAxNS41ODE3IDI4IDIwIDI4WiIgZmlsbD0iI0NDQyIvPgo8L3N2Zz4K';
                const productName = firstProduct ? firstProduct.name : 'No Product';
                const totalItems = order.items ? order.items.length : 0;
                
                tableHtml += `
                    <div class="order-card" data-order='${encodeOrderData(order)}' style="background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="flex-shrink: 0;">
                                <img src="${productImage}" alt="${productName}" style="width: 60px; height: 60px; border-radius: 8px; object-fit: cover; border: 1px solid var(--border-color);">
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 600; font-size: 1rem; color: var(--text-color); margin-bottom: 4px;">${order.shippingName}</div>
                                <div style="font-size: 0.9rem; color: var(--muted-color); margin-bottom: 4px;"> ${order.shippingMobile || 'N/A'}</div>
                                <div style="font-size: 0.85rem; color: var(--muted-color); line-height: 1.3; margin-bottom: 6px;"> ${order.shippingAddress || 'N/A'}</div>
                                <div style="display: flex; align-items: center; gap: 10px; font-size: 0.8rem; color: var(--muted-color);">
                                    <span> ${totalItems} item${totalItems !== 1 ? 's' : ''}</span>
                                    <span> ${order.totalAmount.toFixed(2)}</span>
                                    <span> ${orderDate}</span>
                                </div>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 8px; align-items: center;">
                                <div class="order-status-badge status-${order.status.toLowerCase()}" style="padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; background: ${getStatusColor(order.status)}; color: white; min-width: 70px; text-align: center;">
                                    ${order.status}
                                </div>
                                <button class="update-status-btn" data-user-id="${order.userId}" data-order-id="${order.orderId}" style="background: var(--primary-red); color: white; border: none; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease;">
                                    <i class="fas fa-edit" style="font-size: 14px;"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            tableHtml += `
                </div>
            `;
            orderTableContainer.innerHTML = tableHtml;

            // Add event listeners for order cards (click to view details)
            orderTableContainer.querySelectorAll('.order-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    // Don't trigger if clicking on the update status button
                    if (e.target.closest('.update-status-btn')) {
                        return;
                    }
                    
                    // Debug: Log the raw data
                    console.log('Raw order data:', card.dataset.order);
                    
                    const orderData = decodeOrderData(card.dataset.order);
                    if (orderData) {
                        showOrderDetailsModal(orderData);
                    } else {
                        handleCorruptedOrderData(card, new Error('Failed to parse order data'));
                    }
                });
            });

            // Add event listeners for update status buttons
            orderTableContainer.querySelectorAll('.update-status-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent card click
                    const userId = button.dataset.userId;
                    const orderId = button.dataset.orderId;
                    showStatusUpdateModal(userId, orderId);
                });
            });
        }

        // Search functionality for orders
        function searchOrders(searchTerm) {
            if (!searchTerm || searchTerm.trim() === '') {
                // If search is empty, show all orders
                renderOrderTable(window.allOrders);
                searchResultsInfo.style.display = 'none';
                return;
            }

            const searchLower = searchTerm.toLowerCase().trim();
            const filteredOrders = {};

            // Search through all orders
            for (const userId in window.allOrders) {
                for (const orderId in window.allOrders[userId]) {
                    const order = window.allOrders[userId][orderId];
                    
                    // Search by Order ID
                    if (orderId.toLowerCase().includes(searchLower)) {
                        if (!filteredOrders[userId]) filteredOrders[userId] = {};
                        filteredOrders[userId][orderId] = order;
                        continue;
                    }
                    
                    // Search by Customer Name
                    if (order.shippingName && order.shippingName.toLowerCase().includes(searchLower)) {
                        if (!filteredOrders[userId]) filteredOrders[userId] = {};
                        filteredOrders[userId][orderId] = order;
                        continue;
                    }
                    
                    // Search by Customer Mobile
                    if (order.shippingMobile && order.shippingMobile.includes(searchTerm)) {
                        if (!filteredOrders[userId]) filteredOrders[userId] = {};
                        filteredOrders[userId][orderId] = order;
                        continue;
                    }
                }
            }

            // Show filtered results
            renderOrderTable(filteredOrders);
            
            // Show search results info
            const resultCount = Object.keys(filteredOrders).length > 0 ? 
                Object.values(filteredOrders).reduce((total, userOrders) => total + Object.keys(userOrders).length, 0) : 0;
            
            if (resultCount > 0) {
                searchResultsInfo.innerHTML = `<i class="fas fa-check-circle" style="color: #28a745; margin-right: 5px;"></i>Found ${resultCount} order(s) matching "${searchTerm}"`;
                searchResultsInfo.style.display = 'block';
            } else {
                searchResultsInfo.innerHTML = `<i class="fas fa-info-circle" style="color: #ffc107; margin-right: 5px;"></i>No orders found matching "${searchTerm}"`;
                searchResultsInfo.style.display = 'block';
            }
        }

        // Add event listeners for search functionality
        if (orderSearchBtn) {
            orderSearchBtn.addEventListener('click', () => {
                const searchTerm = orderSearchInput.value;
                searchOrders(searchTerm);
            });
        }

        if (orderClearSearchBtn) {
            orderClearSearchBtn.addEventListener('click', () => {
                orderSearchInput.value = '';
                searchResultsInfo.style.display = 'none';
                renderOrderTable(window.allOrders);
            });
        }

        // Add enter key support for search input
        if (orderSearchInput) {
            orderSearchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const searchTerm = orderSearchInput.value;
                    searchOrders(searchTerm);
                }
            });
        }

        async function updateOrderStatus(userId, orderId, newStatus) {
            try {
                const orderRef = ref(database, `orders/${userId}/${orderId}`);
                
                // Get current order data to compare status
                const orderSnapshot = await new Promise((resolve, reject) => {
                    onValue(orderRef, resolve, { onlyOnce: true });
                });
                const orderData = orderSnapshot.val();
                
                if (orderData && orderData.status !== newStatus) {
                    // Send Telegram notification for status change
                    sendOrderStatusUpdateNotification(orderData, orderData.status, newStatus);
                }
                
                await update(orderRef, { status: newStatus });
                console.log(`Order ${orderId} status updated to ${newStatus}`);
            } catch (error) {
                console.error('Error updating order status:', error);
                throw error;
            }
        }

        async function deleteOrder(userId, orderId) {
            // Order deletion confirmed - no confirm dialog needed
                const orderRef = ref(database, `orders/${userId}/${orderId}`);
                await remove(orderRef);
                console.log(`Order ${orderId} deleted.`);
            }

        // Function to render today's orders
        function renderTodayOrders() {
            const todayOrdersContainer = document.getElementById('today-orders-container');
            if (!todayOrdersContainer) return;

            // Get today's date (start of day)
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayTimestamp = today.getTime();

            // Check if database is available
            if (!database) {
                todayOrdersContainer.innerHTML = '<p style="text-align: center; color: var(--muted-color);">Database not available.</p>';
                return;
            }

            // Show loading state
            todayOrdersContainer.innerHTML = '<p style="text-align: center; color: var(--muted-color);">Loading today\'s orders...</p>';

            // Listen to orders data
            onValue(ref(database, 'orders'), (snapshot) => {
                const allOrders = snapshot.val();
                if (!allOrders || Object.keys(allOrders).length === 0) {
                    todayOrdersContainer.innerHTML = '<p style="text-align: center; color: var(--muted-color);">No orders placed today.</p>';
                    return;
                }

                const todayOrders = [];
                for (const userId in allOrders) {
                    for (const orderId in allOrders[userId]) {
                        const order = allOrders[userId][orderId];
                        const orderDate = new Date(order.date);
                        orderDate.setHours(0, 0, 0, 0);
                        
                        // Check if order was placed today
                        if (orderDate.getTime() === todayTimestamp) {
                            todayOrders.push({ userId, ...order });
                        }
                    }
                }

                if (todayOrders.length === 0) {
                    todayOrdersContainer.innerHTML = '<p style="text-align: center; color: var(--muted-color);">No orders placed today.</p>';
                    return;
                }

                // Sort orders by time (most recent first)
                todayOrders.sort((a, b) => b.date - a.date);

                let todayOrdersHtml = `
                    <div style="display: grid; gap: 15px; padding: 10px; margin-top: 10px;">
                `;

                todayOrders.forEach(order => {
                    // Validate order data before rendering
                    if (!validateOrderData(order)) {
                        console.warn('Skipping invalid today order:', { userId: order.userId, orderId: order.orderId, order });
                        return; // Skip this order
                    }
                    
                    const orderTime = new Date(order.date).toLocaleTimeString('en-US', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: true 
                    });
                    const firstProduct = order.items && order.items.length > 0 ? order.items[0] : null;
                    const productImage = firstProduct ? (firstProduct.imageUrl || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0yMCAyNEMyMi4wOTExIDI0IDI0IDIyLjA5MTEgMjQgMjBDMjQgMTcuOTA4OSAyMi4wOTExIDE2IDIwIDE2QzE3LjkwODkgMTYgMTYgMTcuOTA4OSAxNiAyMEMxNiAyMi4wOTExIDE3LjkwODkgMjQgMjAgMjRaIiBmaWxsPSIjQ0NDIi8+CjxwYXRoIGQ9Ik0yMCAyOEMyNC40MTgzIDI4IDI4IDI0LjQxODMgMjggMjBIMTJDMTIgMjQuNDE4MyAxNS41ODE3IDI4IDIwIDI4WiIgZmlsbD0iI0NDQyIvPgo8L3N2Zz4K') : 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0yMCAyNEMyMi4wOTExIDI0IDI0IDIyLjA5MTEgMjQgMjBDMjQgMTcuOTA4OSAyMi4wOTExIDE2IDIwIDE2QzE3LjkwODkgMTYgMTYgMTcuOTA4OSAxNiAyMEMxNiAyMi4wOTExIDE3LjkwODkgMjQgMjAgMjRaIiBmaWxsPSIjQ0NDIi8+CjxwYXRoIGQ9Ik0yMCAyOEMyNC40MTgzIDI4IDI4IDI0LjQxODMgMjggMjBIMTJDMTIgMjQuNDE4MyAxNS41ODE3IDI4IDIwIDI4WiIgZmlsbD0iI0NDQyIvPgo8L3N2Zz4K';
                    const productName = firstProduct ? firstProduct.name : 'No Product';
                    const totalItems = order.items ? order.items.length : 0;
                    
                    todayOrdersHtml += `
                        <div class="order-card" data-order='${encodeOrderData(order)}' style="background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="flex-shrink: 0;">
                                    <img src="${productImage}" alt="${productName}" style="width: 60px; height: 60px; border-radius: 8px; object-fit: cover; border: 1px solid var(--border-color);">
                                </div>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-weight: 600; font-size: 1rem; color: var(--text-color); margin-bottom: 4px;">${order.shippingName}</div>
                                    <div style="font-size: 0.9rem; color: var(--muted-color); margin-bottom: 4px;"> ${order.shippingMobile || 'N/A'}</div>
                                    <div style="font-size: 0.85rem; color: var(--muted-color); line-height: 1.3; margin-bottom: 6px;"> ${order.shippingAddress || 'N/A'}</div>
                                    <div style="display: flex; align-items: center; gap: 10px; font-size: 0.8rem; color: var(--muted-color);">
                                        <span> ${totalItems} item${totalItems !== 1 ? 's' : ''}</span>
                                        <span> ${order.totalAmount.toFixed(2)}</span>
                                        <span> ${orderTime}</span>
                                    </div>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 8px; align-items: center;">
                                    <div class="order-status-badge status-${order.status.toLowerCase()}" style="padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; background: ${getStatusColor(order.status)}; color: white; min-width: 70px; text-align: center;">
                                        ${order.status}
                                    </div>
                                    <button class="update-status-btn" data-user-id="${order.userId}" data-order-id="${order.orderId}" style="background: var(--primary-red); color: white; border: none; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease;">
                                        <i class="fas fa-edit" style="font-size: 14px;"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });

                todayOrdersHtml += `
                    </div>
                `;
                todayOrdersContainer.innerHTML = todayOrdersHtml;

                // Add event listeners for today's order cards (click to view details)
                todayOrdersContainer.querySelectorAll('.order-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        // Don't trigger if clicking on the update status button
                        if (e.target.closest('.update-status-btn')) {
                            return;
                        }
                        
                        // Debug: Log the raw data
                        console.log('Raw today order data:', card.dataset.order);
                        
                        const orderData = decodeOrderData(card.dataset.order);
                        if (orderData) {
                            showOrderDetailsModal(orderData);
                        } else {
                            handleCorruptedOrderData(card, new Error('Failed to parse today order data'));
                        }
                    });
                });

                // Add event listeners for update status buttons
                todayOrdersContainer.querySelectorAll('.update-status-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent card click
                        const userId = button.dataset.userId;
                        const orderId = button.dataset.orderId;
                        showStatusUpdateModal(userId, orderId);
                    });
                });
            }, (error) => {
                console.error('Error loading today\'s orders:', error);
                todayOrdersContainer.innerHTML = '<p style="text-align: center; color: var(--muted-color);">Error loading today\'s orders.</p>';
            });
        }

        // Listen for all orders changes to re-render the table
        onValue(ref(database, 'orders'), (snapshot) => {
            const allOrders = snapshot.val() || {};
            renderOrderTable(allOrders);
        });

        // Refresh order table when navigating to the orders section
        window.addEventListener('hashchange', () => {
            if (window.location.hash === '#orders') {
                onValue(ref(database, 'orders'), (snapshot) => {
                    const allOrders = snapshot.val() || {};
                    renderOrderTable(allOrders);
                }, { onlyOnce: true });
            }
        });

        // --- Slider / Ad Management ---
        const addSliderImageBtn = document.getElementById('add-slider-image-btn');
        const addSliderImageModal = document.getElementById('add-slider-image-modal');
        const addSliderImageForm = document.getElementById('add-slider-image-form');
        const sliderImageUrlInput = document.getElementById('slider-image-url-input');
        const sliderImageTableContainer = document.getElementById('slider-image-table-container');

        function renderSliderImageTable(sliderImages) {
            if (Object.keys(sliderImages).length === 0) {
                sliderImageTableContainer.innerHTML = '<p style="text-align: center; color: var(--muted-color);">No slider images to display.</p>';
                return;
            }

            let tableHtml = `
                <table style="width: 100%; border-collapse: collapse; text-align: left;">
                    <thead>
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <th style="padding: 10px;">Preview</th>
                            <th style="padding: 10px;">URL</th>
                            <th style="padding: 10px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            for (const imageId in sliderImages) {
                const image = sliderImages[imageId];
                tableHtml += `
                    <tr style="border-bottom: 1px solid var(--border-color);">
                        <td data-label="Preview:" style="padding: 10px;"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='60'%3E%3Crect width='100%25' height='100%25' fill='%23f0f0f0'/%3E%3C/svg%3E" alt="Slider Image" class="admin-slider-image" data-src="${image.downloadURL}" style="width: 100px; height: 60px; object-fit: cover; border-radius: 4px;"></td>
                        <td data-label="URL:" style="padding: 10px; word-break: break-all;">${image.downloadURL}</td>
                        <td data-label="Actions:" style="padding: 10px; text-align: center;">
                            <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                                <button class="icon-btn edit-slider-image-btn" data-image-id="${imageId}" data-image-url="${image.downloadURL}" style="color: #007bff; background: #f8f9fa; border: 1px solid #dee2e6; padding: 6px 10px; border-radius: 4px;">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="icon-btn delete-slider-image-btn" data-image-id="${imageId}" style="color: white; background: var(--primary-red); border: none; padding: 6px 10px; border-radius: 4px;">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }

            tableHtml += `
                    </tbody>
                </table>
            `;
            sliderImageTableContainer.innerHTML = tableHtml;

            // Load images with enhanced loading
            sliderImageTableContainer.querySelectorAll('.admin-slider-image').forEach(img => {
                const imageSrc = img.getAttribute('data-src');
                if (imageSrc) {
                    loadAdminImageWithFallback(img, imageSrc, 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjYwIiB2aWV3Qm94PSIwIDAgMTAwIDYwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik01MCAzNkM1Mi4wOTExIDM2IDU0IDM0LjA5MTEgNTQgMzJDNTQgMjkuOTA4OSA1Mi4wOTExIDI4IDUwIDI4QzQ3LjkwODkgMjggNDYgMjkuOTA4OSA0NiAzMkM0NiAzNC4wOTExIDQ3LjkwODkgMzYgNTAgMzZaIiBmaWxsPSIjQ0NDIi8+CjxwYXRoIGQ9Ik01MCA0MEM1NC40MTgzIDQwIDU4IDM2LjQxODMgNTggMzJIMjJDMTIgMzYuNDE4MyAxNS41ODE3IDQwIDIwIDQwWiIgZmlsbD0iI0NDQyIvPgo8L3N2Zz4K');
                }
            });

            // Add event listeners for delete buttons
            const deleteButtons = sliderImageTableContainer.querySelectorAll('.delete-slider-image-btn');
            deleteButtons.forEach(button => {
                button.addEventListener('click', (e) => deleteSliderImage(e.currentTarget.dataset.imageId));
            });

            // Add event listeners for edit buttons
            const editButtons = sliderImageTableContainer.querySelectorAll('.edit-slider-image-btn');
            editButtons.forEach(button => {
                button.addEventListener('click', (e) => editSliderImage(e.currentTarget.dataset.imageId, e.currentTarget.dataset.imageUrl));
            });
        }

        addSliderImageBtn.addEventListener('click', () => {
            sliderImageUrlInput.value = '';
            addSliderImageModal.style.display = 'flex';
        });

        addSliderImageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const imageUrl = sliderImageUrlInput.value;
            if (imageUrl) {
                const editingImageId = addSliderImageForm.dataset.editingImageId;
                
                if (editingImageId) {
                    // Update existing image
                    const imageRef = ref(database, `sliderImages/${editingImageId}`);
                    await update(imageRef, { downloadURL: imageUrl });
                    delete addSliderImageForm.dataset.editingImageId;
                } else {
                    // Add new image
                    const sliderRef = ref(database, 'sliderImages');
                    const newImageRef = push(sliderRef);
                    await set(newImageRef, { downloadURL: imageUrl });
                }
                
                addSliderImageModal.style.display = 'none';
                addSliderImageForm.reset();
                
                // Reset modal title and button text
                const modalTitle = addSliderImageModal.querySelector('h2');
                const submitBtn = addSliderImageForm.querySelector('button[type="submit"]');
                if (modalTitle) modalTitle.textContent = 'Add New Slider Image';
                if (submitBtn) submitBtn.innerHTML = '<i class="fas fa-plus" style="margin-right: 5px;"></i>Add Image';
            }
        });

        async function deleteSliderImage(imageId) {
            if (confirm("Are you sure you want to delete this slider image?")) {
                const imageRef = ref(database, `sliderImages/${imageId}`);
                await remove(imageRef);
            }
        }

        function editSliderImage(imageId, currentUrl) {
            sliderImageUrlInput.value = currentUrl;
            addSliderImageModal.style.display = 'flex';
            
            // Change modal title and button text for editing
            const modalTitle = addSliderImageModal.querySelector('h2');
            const submitBtn = addSliderImageForm.querySelector('button[type="submit"]');
            
            if (modalTitle) modalTitle.textContent = 'Edit Slider Image';
            if (submitBtn) submitBtn.innerHTML = '<i class="fas fa-save" style="margin-right: 5px;"></i>Update Image';
            
            // Store the editing image ID
            addSliderImageForm.dataset.editingImageId = imageId;
        }

        // Show skeleton loading initially for slider images
        if (sliderImageTableContainer) {
            showTableSkeleton(sliderImageTableContainer, 'Slider Images', 'Add Image', 4);
        }

        // Listen for slider image changes to re-render the table
        onValue(ref(database, 'sliderImages'), (snapshot) => {
            const sliderImages = snapshot.val() || {};
            renderSliderImageTable(sliderImages);
        });

        // Refresh slider image table when navigating to the slider section
        window.addEventListener('hashchange', () => {
            if (window.location.hash === '#slider') {
                onValue(ref(database, 'sliderImages'), (snapshot) => {
                    const sliderImages = snapshot.val() || {};
                    renderSliderImageTable(sliderImages);
                }, { onlyOnce: true });
            }
        });

        // --- Message Management ---
        const messagesTableContainer = document.getElementById('messages-table-container');

        function renderMessagesTable(messages) {
            if (Object.keys(messages).length === 0) {
                messagesTableContainer.innerHTML = '<p style="text-align: center; color: var(--muted-color);">No messages to display.</p>';
                return;
            }

            let tableHtml = `
                <table style="width: 100%; border-collapse: collapse; text-align: left;">
                    <thead>
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <th style="padding: 10px;">Date</th>
                            <th style="padding: 10px;">Sender Name</th>
                            <th style="padding: 10px;">Email</th>
                            <th style="padding: 10px;">Message</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // Sort messages by date (most recent first)
            const sortedMessages = Object.values(messages).sort((a, b) => b.date - a.date);

            sortedMessages.forEach((message, index) => {
                const messageDate = new Date(message.date).toLocaleDateString() + ' ' + new Date(message.date).toLocaleTimeString();
                const truncatedMessage = message.message.length > 50 ? message.message.substring(0, 50) + '...' : message.message;
                
                // Store message data in data attributes for safer handling
                const messageId = `msg_${index}_${Date.now()}`;
                
                tableHtml += `
                    <tr style="border-bottom: 1px solid var(--border-color);">
                        <td data-label="Date:" style="padding: 10px;">${messageDate}</td>
                        <td data-label="Sender Name:" style="padding: 10px;">${message.name}</td>
                        <td data-label="Email:" style="padding: 10px;">${message.email}</td>
                        <td data-label="Message:" style="padding: 10px; cursor: pointer; color: var(--primary-red); text-decoration: underline;" 
                            class="message-cell" 
                            data-message-id="${messageId}"
                            data-name="${message.name.replace(/"/g, '&quot;')}" 
                            data-email="${message.email.replace(/"/g, '&quot;')}" 
                            data-date="${messageDate}" 
                            data-message="${message.message.replace(/"/g, '&quot;')}">
                            ${truncatedMessage}
                        </td>
                    </tr>
                `;
            });

            tableHtml += `
                    </tbody>
                </table>
            `;
            messagesTableContainer.innerHTML = tableHtml;
            
            // Add click event listeners to message cells
            const messageCells = messagesTableContainer.querySelectorAll('.message-cell');
            messageCells.forEach(cell => {
                cell.addEventListener('click', function() {
                    const name = this.getAttribute('data-name');
                    const email = this.getAttribute('data-email');
                    const date = this.getAttribute('data-date');
                    const message = this.getAttribute('data-message');
                    showMessageModal(name, email, date, message);
                });
            });
        }

        // Function to show message modal
        function showMessageModal(name, email, date, message) {
            const modal = document.getElementById('message-view-modal');
            const modalContent = document.getElementById('message-modal-content');
            
            modalContent.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="display: grid; gap: 15px; margin-bottom: 20px;">
                        <div>
                            <strong style="color: var(--muted-color); display: block; margin-bottom: 5px;">From:</strong>
                            <div style="font-size: 1.1rem; color: var(--text-color);">${name}</div>
                        </div>
                        <div>
                            <strong style="color: var(--muted-color); display: block; margin-bottom: 5px;">Email:</strong>
                            <div style="color: var(--primary-red);">${email}</div>
                        </div>
                        <div>
                            <strong style="color: var(--muted-color); display: block; margin-bottom: 5px;">Date:</strong>
                            <div style="color: var(--text-color);">${date}</div>
                        </div>
                    </div>
                    <div>
                        <strong style="color: var(--muted-color); display: block; margin-bottom: 10px;">Message:</strong>
                        <div style="background: var(--surface-dark-color); padding: 20px; border-radius: 8px; border-left: 4px solid var(--primary-red); line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">${message}</div>
                    </div>
                </div>
            `;
            
            modal.style.display = 'flex';
            
            // Close modal when clicking outside the content
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Listen for messages changes to re-render the table
        onValue(ref(database, 'messages'), (snapshot) => {
            const messages = snapshot.val() || {};
            renderMessagesTable(messages);
        });

        // Refresh messages table when navigating to the messages section
        window.addEventListener('hashchange', () => {
            if (window.location.hash === '#messages') {
                onValue(ref(database, 'messages'), (snapshot) => {
                    const messages = snapshot.val() || {};
                    renderMessagesTable(messages);
                }, { onlyOnce: true });
            }
        });




        // Function to show status update modal
        function showStatusUpdateModal(userId, orderId) {
            const modal = document.getElementById('status-update-modal');
            const statusSelect = document.getElementById('status-update-select');
            const updateBtn = document.getElementById('status-update-btn');
            
            // Set current order data
            updateBtn.dataset.userId = userId;
            updateBtn.dataset.orderId = orderId;
            
            // Add event listener for update button
            updateBtn.onclick = async () => {
                const newStatus = statusSelect.value;
                try {
                    await updateOrderStatus(userId, orderId, newStatus);
                    modal.style.display = 'none';
                    // Refresh the orders display
                    renderTodayOrders();
                    // Show success message
                    // Status updated successfully - no alert needed
                } catch (error) {
                    console.error('Error updating order status:', error);
                    // Error updating status - no alert needed
                }
            };
            
            // Show modal
            modal.style.display = 'flex';
        }

        // Function to show/hide sections based on navigation
        function showSection(sectionId) {
            console.log('showSection called with:', sectionId);
            
            // Hide all sections
            const allSections = document.querySelectorAll('.admin-section');
            allSections.forEach(section => {
                section.style.display = 'none';
                section.classList.remove('active');
            });
            
            // Show the selected section
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.style.display = 'block';
                targetSection.classList.add('active');
                console.log('Section shown:', sectionId);
            } else {
                console.error('Section not found:', sectionId);
            }
            
            // Update active navigation item
            const allNavItems = document.querySelectorAll('.admin-nav-item');
            allNavItems.forEach(item => {
                item.classList.remove('active');
            });
            
            const activeNavItem = document.querySelector(`[data-route="${sectionId}"]`);
            if (activeNavItem) {
                activeNavItem.classList.add('active');
                console.log('Navigation updated for:', sectionId);
            } else {
                console.error('Navigation item not found for:', sectionId);
            }
        }

        // Function to show order details in full screen modal
        function showOrderDetailsModal(order) {
            const modal = document.getElementById('order-details-modal');
            const content = document.getElementById('order-details-content');
            
            // Check if we have minimal data (just orderId and userId) and need to fetch full order
            if (order && order.orderId && order.userId && !order.shippingName) {
                // We have minimal data, try to fetch the full order from the database
                if (window.allOrders && 
                    window.allOrders[order.userId] && 
                    window.allOrders[order.userId][order.orderId]) {
                    order = window.allOrders[order.userId][order.orderId];
                } else {
                    // Show error message if we can't find the full order data
                    content.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--muted-color);">
                            <div style="font-size: 2rem; margin-bottom: 20px;"></div>
                            <div style="font-size: 1.2rem; margin-bottom: 10px;">Order Data Not Found</div>
                            <div>Unable to load complete order details.</div>
                            <div style="font-size: 0.9rem; margin-top: 10px;">Order ID: ${order.orderId}</div>
                        </div>
                    `;
                    modal.style.display = 'flex';
                    return;
                }
            }
            
            // Validate that we have the required order data
            if (!validateOrderData(order)) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--muted-color);">
                        <div style="font-size: 2rem; margin-bottom: 20px;"></div>
                        <div style="font-size: 1.2rem; margin-bottom: 10px;">Invalid Order Data</div>
                        <div>This order appears to be corrupted or incomplete.</div>
                        <div style="font-size: 0.9rem; margin-top: 10px;">Order ID: ${order?.orderId || 'Unknown'}</div>
                    </div>
                `;
                modal.style.display = 'flex';
                return;
            }
            
            const orderDate = new Date(order.date).toLocaleDateString() + ' ' + new Date(order.date).toLocaleTimeString();
            
            content.innerHTML = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <h2 style="color: var(--primary-red); margin-bottom: 10px;">Order Details</h2>
                    <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
                        <div class="status-badge status-${order.status.toLowerCase()}" style="padding: 10px 20px; font-size: 1rem;">
                            ${order.status}
                        </div>
                        <div style="background: var(--surface-dark-color); padding: 10px 20px; border-radius: 8px;">
                            <strong>Order ID:</strong> ${order.orderId}
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                    <!-- Customer Information -->
                    <div class="card" style="margin: 0;">
                        <h3 style="color: var(--primary-red); margin-bottom: 20px; display: flex; align-items: center;">
                            <i class="fas fa-user" style="margin-right: 10px;"></i>Customer Information
                        </h3>
                        <div style="display: grid; gap: 15px;">
                            <div>
                                <strong style="color: var(--muted-color); display: block; margin-bottom: 5px;">Name:</strong>
                                <span style="font-size: 1.1rem;">${order.shippingName}</span>
                            </div>
                            <div>
                                <strong style="color: var(--muted-color); display: block; margin-bottom: 5px;">Contact & Address:</strong>
                                <div style="margin-bottom: 8px;">
                                    <span style="font-size: 1.1rem; font-family: monospace; color: var(--primary-red); font-weight: 600;"> ${order.shippingMobile || 'Not provided'}</span>
                                </div>
                                <div>
                                    <span style="font-size: 1rem; line-height: 1.4; color: var(--text-color);"> ${order.shippingAddress || 'Not provided'}</span>
                                </div>
                            </div>

                            <div>
                                <strong style="color: var(--muted-color); display: block; margin-bottom: 5px;">Order Date:</strong>
                                <span style="font-size: 1.1rem;">${orderDate}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Order Summary -->
                    <div class="card" style="margin: 0;">
                        <h3 style="color: var(--primary-red); margin-bottom: 20px; display: flex; align-items: center;">
                            <i class="fas fa-receipt" style="margin-right: 10px;"></i>Order Summary
                        </h3>
                        <div style="display: grid; gap: 15px;">
                            <div>
                                <strong style="color: var(--muted-color); display: block; margin-bottom: 5px;">Total Amount:</strong>
                                <span style="font-size: 1.5rem; font-weight: 700; color: var(--primary-red);">${order.totalAmount.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Items -->
                <div class="card" style="margin-bottom: 30px;">
                    <h3 style="color: var(--primary-red); margin-bottom: 20px; display: flex; align-items: center;">
                        <i class="fas fa-shopping-cart" style="margin-right: 10px;"></i>Order Items
                    </h3>
                    <div style="display: grid; gap: 15px;">
                        ${order.items.map(item => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--surface-dark-color); border-radius: 8px;">
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <img src="${item.imageUrl || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiBmaWxsPSIjRjBGMEYwIi8+CjxwYXRoIGQ9Ik0yNSAyNUgxNVYxNUgyNVYyNVoiIGZpbGw9IiNDQ0NDQ0MiLz4KPC9zdmc+'}" alt="${item.name}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">
                                    <div>
                                        <div style="font-weight: 600; margin-bottom: 5px;">${item.name}</div>
                                        <div style="color: var(--muted-color); font-size: 0.9rem;">Quantity: ${item.qty}</div>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: 600; color: var(--primary-red);">${(item.price * item.qty).toFixed(2)}</div>
                                    <div style="color: var(--muted-color); font-size: 0.9rem;">${item.price.toFixed(2)} each</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- Order Progress -->
                <div class="card" style="margin-bottom: 30px;">
                    <h3 style="color: var(--primary-red); margin-bottom: 20px; display: flex; align-items: center;">
                        <i class="fas fa-chart-line" style="margin-right: 10px;"></i>Order Progress
                    </h3>
                    <div class="order-progress-bar" style="margin: 20px 0;">
                        <div class="order-progress-step ${getProgressStepClass(order.status, 'Pending')}" data-step="Pending">
                            <div class="progress-step-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <span class="progress-step-label">Pending</span>
                        </div>
                        <div class="order-progress-step ${getProgressStepClass(order.status, 'Processing')}" data-step="Processing">
                            <div class="progress-step-icon">
                                <i class="fas fa-cog"></i>
                            </div>
                            <span class="progress-step-label">Processing</span>
                        </div>
                        <div class="order-progress-step ${getProgressStepClass(order.status, 'Shipped')}" data-step="Shipped">
                            <div class="progress-step-icon">
                                <i class="fas fa-shipping-fast"></i>
                            </div>
                            <span class="progress-step-label">Shipped</span>
                        </div>
                        <div class="order-progress-step ${getProgressStepClass(order.status, 'Delivered')}" data-step="Delivered">
                            <div class="progress-step-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <span class="progress-step-label">Delivered</span>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <div style="font-size: 1.2rem; font-weight: 600; color: var(--primary-red);">
                            ${getOrderProgressPercentage(order.status)}% Complete
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                    <button onclick="updateOrderStatusFromModal('${order.userId}', '${order.orderId}', 'Processing')" style="background-color: #007bff; color: white; padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer;">
                        <i class="fas fa-cog" style="margin-right: 8px;"></i>Mark as Processing
                    </button>
                    <button onclick="updateOrderStatusFromModal('${order.userId}', '${order.orderId}', 'Shipped')" style="background-color: #28a745; color: white; padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer;">
                        <i class="fas fa-shipping-fast" style="margin-right: 8px;"></i>Mark as Shipped
                    </button>
                    <button onclick="updateOrderStatusFromModal('${order.userId}', '${order.orderId}', 'Delivered')" style="background-color: #17a2b8; color: white; padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer;">
                        <i class="fas fa-check-circle" style="margin-right: 8px;"></i>Mark as Delivered
                    </button>
                </div>
            `;
            
            modal.style.display = 'flex';
        }

        // Helper function to update order status from modal
        function updateOrderStatusFromModal(userId, orderId, newStatus) {
            updateOrderStatus(userId, orderId, newStatus);
            // Close modal after status update
            document.getElementById('order-details-modal').style.display = 'none';
        }

        // Make function globally accessible for onclick handlers
        window.updateOrderStatusFromModal = updateOrderStatusFromModal;
        window.addGroceryProducts = addGroceryProducts;

        // Helper functions for order progress
        function getProgressStepClass(currentStatus, stepStatus) {
            const statusOrder = ['Pending', 'Processing', 'Shipped', 'Delivered'];
            const currentIndex = statusOrder.indexOf(currentStatus);
            const stepIndex = statusOrder.indexOf(stepStatus);
            
            if (stepIndex < currentIndex) {
                return 'completed';
            } else if (stepIndex === currentIndex) {
                return 'current';
            } else {
                return '';
            }
        }

        function getOrderProgressPercentage(status) {
            const statusOrder = ['Pending', 'Processing', 'Shipped', 'Delivered'];
            const currentIndex = statusOrder.indexOf(status);
            if (currentIndex === -1) return 0;
            return Math.round(((currentIndex + 1) / statusOrder.length) * 100);
        }

        // --- Telegram Command System ---
        // Function to handle Telegram commands for order management
        async function handleTelegramCommand(chatId, command, orderId) {
            try {
                console.log(`Handling Telegram command: ${command} for order: ${orderId}`);
                
                // Validate inputs
                if (!orderId || typeof orderId !== 'string') {
                    console.error('Invalid order ID:', orderId);
                    await sendTelegramMessage(chatId, ' Invalid order ID provided.');
                    return;
                }
                
                if (!database) {
                    console.error('Database not available');
                    await sendTelegramMessage(chatId, ' Database connection not available. Please try again.');
                    return;
                }
                
                // Get all orders to find the specific order
                const ordersRef = ref(database, 'orders');
                const snapshot = await new Promise((resolve, reject) => {
                    onValue(ordersRef, resolve, { onlyOnce: true });
                });
                
                const allOrders = snapshot.val();
                if (!allOrders) {
                    console.log('No orders found in database');
                    await sendTelegramMessage(chatId, ' No orders found in the system.');
                    return;
                }

                console.log('Searching for order ID:', orderId);
                console.log('Available orders:', Object.keys(allOrders));

                // Find the order by ID across all users
                let foundOrder = null;
                let foundUserId = null;
                
                for (const userId in allOrders) {
                    console.log(`Checking user ${userId} for order ${orderId}`);
                    if (allOrders[userId] && allOrders[userId][orderId]) {
                        foundOrder = allOrders[userId][orderId];
                        foundUserId = userId;
                        console.log(`Order found! User: ${userId}, Order:`, foundOrder);
                        break;
                    }
                }

                if (!foundOrder) {
                    console.log(`Order ${orderId} not found in any user's orders`);
                    await sendTelegramMessage(chatId, ` Order with ID <code>${orderId}</code> not found.`);
                    return;
                }

                console.log(`Processing command ${command} for order:`, foundOrder);

                // Handle different commands
                switch (command.toLowerCase()) {
                    case 'processing':
                        console.log('Marking order as Processing');
                        await updateOrderStatus(foundUserId, orderId, 'Processing');
                        await sendTelegramMessage(chatId, ` Order <code>${orderId}</code> marked as <b>Processing</b>`);
                        break;
                        
                    case 'shipped':
                        console.log('Marking order as Shipped');
                        await updateOrderStatus(foundUserId, orderId, 'Shipped');
                        await sendTelegramMessage(chatId, ` Order <code>${orderId}</code> marked as <b>Shipped</b>`);
                        break;
                        
                    case 'delivered':
                        console.log('Marking order as Delivered');
                        await updateOrderStatus(foundUserId, orderId, 'Delivered');
                        await sendTelegramMessage(chatId, ` Order <code>${orderId}</code> marked as <b>Delivered</b>`);
                        break;
                        
                    case 'cancel':
                        console.log('Marking order as Cancelled');
                        await updateOrderStatus(foundUserId, orderId, 'Cancelled');
                        await sendTelegramMessage(chatId, ` Order <code>${orderId}</code> marked as <b>Cancelled</b>`);
                        break;
                        
                    default:
                        console.log('Invalid command:', command);
                        await sendTelegramMessage(chatId, ` Invalid command. Use: processing, shipped, delivered, or cancel`);
                        break;
                }
                
                console.log(`Command ${command} completed successfully for order ${orderId}`);
                
            } catch (error) {
                console.error('Error handling Telegram command:', error);
                await sendTelegramMessage(chatId, ' Error processing command. Please try again.');
            }
        }

        // Function to send help message with available commands
        async function sendTelegramHelp(chatId) {
            const helpMessage = ` <b>TELEGRAM BOT COMMANDS</b>\n\n` +
                ` <b>Available Commands:</b>\n\n` +
                ` <b>Mark as Processing:</b>\n` +
                `<code>/processing ORDER_ID</code>\n\n` +
                ` <b>Mark as Shipped:</b>\n` +
                `<code>/shipped ORDER_ID</code>\n\n` +
                ` <b>Mark as Delivered:</b>\n` +
                `<code>/delivered ORDER_ID</code>\n\n` +
                ` <b>Cancel Order:</b>\n` +
                `<code>/cancel ORDER_ID</code>\n\n` +
                ` <b>List Recent Orders:</b>\n` +
                `<code>/orders</code>\n\n` +
                ` <b>How to Use:</b>\n` +
                `1 Copy Order ID from any notification\n` +
                `2 Type command: <code>/processing ORDER_ID</code>\n` +
                `3 Bot confirms status update\n` +
                `4 Order status changes immediately\n\n` +
                ` <b>Ready to manage orders!</b>`;
            
            await sendTelegramMessage(chatId, helpMessage);
        }

        // Function to list recent orders
        async function listRecentOrders(chatId) {
            try {
                const ordersRef = ref(database, 'orders');
                const snapshot = await new Promise((resolve, reject) => {
                    onValue(ordersRef, resolve, { onlyOnce: true });
                });
                
                const allOrders = snapshot.val();
                if (!allOrders) {
                    await sendTelegramMessage(chatId, ' No orders found in the system.');
                    return;
                }

                // Collect all orders and sort by date
                const ordersList = [];
                for (const userId in allOrders) {
                    for (const orderId in allOrders[userId]) {
                        const order = allOrders[userId][orderId];
                        ordersList.push({
                            orderId,
                            userId,
                            ...order
                        });
                    }
                }

                // Sort by date (most recent first) and take last 10
                ordersList.sort((a, b) => b.date - a.date);
                const recentOrders = ordersList.slice(0, 10);

                let message = ` <b>RECENT ORDERS (Last 10)</b>\n\n`;
                
                recentOrders.forEach((order, index) => {
                    const orderDate = new Date(order.date).toLocaleString('en-IN');
                    const status = order.status || 'Pending';
                    const statusEmoji = {
                        'Pending': '',
                        'Processing': '',
                        'Shipped': '',
                        'Delivered': '',
                        'Cancelled': ''
                    }[status] || '';
                    
                    message += `${index + 1}. <b>${statusEmoji} ${status}</b>\n`;
                    message += `    ID: <code>${order.orderId}</code>\n`;
                    message += `    Customer: ${order.shippingName}\n`;
                    message += `    Amount: ${order.totalAmount.toFixed(2)}\n`;
                    message += `    Date: ${orderDate}\n\n`;
                });

                message += ` <b>Use commands like:</b>\n`;
                message += `<code>/processing ORDER_ID</code> to update status`;
                
                await sendTelegramMessage(chatId, message);
                
            } catch (error) {
                console.error('Error listing recent orders:', error);
                await sendTelegramMessage(chatId, ' Error fetching orders. Please try again.');
            }
        }

        // Function to set up webhook for Telegram commands
        // This function will be called periodically to check for new messages
        async function checkTelegramUpdates() {
            try {
                // Get updates from Telegram
                const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/getUpdates`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.ok && data.result.length > 0) {
                    console.log('Telegram updates received:', data.result.length);
                    
                    // Process each update
                    for (const update of data.result) {
                        if (update.message && update.message.text) {
                            const chatId = update.message.chat.id.toString();
                            const text = update.message.text.trim();
                            
                            console.log('Processing message:', { chatId, text, authorized: TELEGRAM_CHAT_IDS.includes(chatId) });
                            
                            // Check if this is an authorized chat
                            if (!TELEGRAM_CHAT_IDS.includes(chatId)) {
                                console.log('Unauthorized chat ID:', chatId);
                                continue; // Skip unauthorized chats
                            }
                            
                            // Handle commands
                            if (text.startsWith('/')) {
                                const parts = text.split(' ');
                                const command = parts[0].substring(1); // Remove the /
                                const orderId = parts[1];
                                
                                console.log('Command detected:', { command, orderId });
                                
                                switch (command.toLowerCase()) {
                                    case 'help':
                                        console.log('Sending help message');
                                        await sendTelegramHelp(chatId);
                                        break;
                                        
                                    case 'orders':
                                        console.log('Listing recent orders');
                                        await listRecentOrders(chatId);
                                        break;
                                        
                                    case 'processing':
                                    case 'shipped':
                                    case 'delivered':
                                    case 'cancel':
                                        if (orderId) {
                                            console.log('Processing status update command:', command, orderId);
                                            await handleTelegramCommand(chatId, command, orderId);
                                        } else {
                                            console.log('Missing order ID for command:', command);
                                            await sendTelegramMessage(chatId, ` Please provide an order ID. Example: <code>/${command} ORDER_ID</code>`);
                                        }
                                        break;
                                        
                                    default:
                                        console.log('Unknown command:', command);
                                        await sendTelegramMessage(chatId, ` Unknown command. Type <code>/help</code> for available commands.`);
                                        break;
                                }
                            }
                        }
                    }
                    
                    // Mark updates as processed (optional)
                    if (data.result.length > 0) {
                        const lastUpdateId = data.result[data.result.length - 1].update_id;
                        console.log('Marking updates as processed, last update ID:', lastUpdateId);
                        await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/getUpdates?offset=${lastUpdateId + 1}`);
                    }
                } else {
                    console.log('No new Telegram updates');
                }
            } catch (error) {
                console.error('Error checking Telegram updates:', error);
            }
        }

        // Start checking for Telegram commands every 10 seconds for better responsiveness
        setInterval(checkTelegramUpdates, 10000);
        
        // Also check immediately when admin panel loads
        setTimeout(checkTelegramUpdates, 2000);

        // Send initial help message to all authorized chats
        async function sendInitialHelp() {
            console.log('Sending initial help messages...');
            for (const chatId of TELEGRAM_CHAT_IDS) {
                const welcomeMessage = ` <b>WELCOME TO CHAUDHARY KIRANA STORE BOT!</b>\n\n` +
                    ` <b>Bot Status:</b> Online and Ready\n` +
                    ` <b>Time:</b> ${new Date().toLocaleString('en-IN')}\n\n` +
                    ` <b>You can now manage orders directly from Telegram!</b>\n\n` +
                    ` <b>Quick Start:</b>\n` +
                    ` Type <code>/orders</code> to see recent orders\n` +
                    ` Use <code>/processing ORDER_ID</code> to mark as processing\n` +
                    ` Use <code>/shipped ORDER_ID</code> to mark as shipped\n` +
                    ` Use <code>/delivered ORDER_ID</code> to mark as delivered\n` +
                    ` Use <code>/cancel ORDER_ID</code> to cancel orders\n\n` +
                    ` <b>Type</b> <code>/help</code> <b>for detailed commands</b>`;
                
                await sendTelegramMessage(chatId, welcomeMessage);
            }
        }

        // Send help message when admin panel loads
        setTimeout(sendInitialHelp, 5000);



        // Make functions globally accessible
        window.handleTelegramCommand = handleTelegramCommand;
        window.sendTelegramHelp = sendTelegramHelp;
        window.listRecentOrders = listRecentOrders;
    </script>

    <!-- Fixed Bottom Navigation -->
    <nav class="admin-bottom-nav">
        <a href="#today-orders" class="admin-nav-item active" data-route="today-orders">
            <i class="fas fa-calendar-day"></i>
            <span>Today</span>
        </a>
        <a href="#products" class="admin-nav-item" data-route="products">
            <i class="fas fa-boxes"></i>
            <span>Products</span>
        </a>
        <a href="#orders" class="admin-nav-item" data-route="orders">
            <i class="fas fa-receipt"></i>
            <span>Orders</span>
        </a>
        <a href="#slider" class="admin-nav-item" data-route="slider">
            <i class="fas fa-images"></i>
            <span>Slider</span>
        </a>
        <a href="#messages" class="admin-nav-item" data-route="messages">
            <i class="fas fa-envelope"></i>
            <span>Messages</span>
        </a>
    </nav>
</body>
</html>
